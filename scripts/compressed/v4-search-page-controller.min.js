function SearchPageController(params){this.params=params,self=this,$("section.refine .fa-times-circle").click(function(){self.removeRegion($(this).parent().index()),self.navigate()}),$(window).on("scroll",function(){var bottomOffsetToBeginRequest=1e3;$(window).scrollTop()>=$(document).height()-$(window).height()-bottomOffsetToBeginRequest&&self.fetchNextPage()}).scroll(),$(".fa-search").click(function(){$(".summary").toggle(),$(".text-entry").toggle(),$(".text-entry input").select();var o=$(".fa-search");o.hasClass("selected")?o.removeClass("selected"):o.addClass("selected")})}SearchPageController.prototype.decrementPage=function(){this.params.page--},SearchPageController.prototype.fetchNextPage=function(){this.fetching||this.fetchedAll||(this.fetching=!0,this.incrementPage(),$.ajax(this.getSearchResultsUrl()).done(function(data,textStatus,jqXHR){return console.log(jqXHR.status+" "+textStatus),204==jqXHR.status?(self.decrementPage(),self.fetching=!1,void(self.fetchedAll=!0)):($(".datasets").append(data),void(self.fetching=!1))}))},SearchPageController.prototype.getSearchPageUrl=function(){var url;if(this.params.regions.length>0||null!=this.params.autoCompletedRegion){url="/";var regionNames=this.params.regions.map(function(region){return region.name.replace(/,/g,"").replace(/ /g,"_")});null!=this.params.autoCompletedRegion&&(console.log(this.params.autoCompletedRegion),regionNames.push(this.params.autoCompletedRegion.replace(/,/g,"").replace(/ /g,"_"))),url+=regionNames.join("_vs_")}else url="/v4-search";return url+=this.getSearchQueryString()},SearchPageController.prototype.getSearchResultsUrl=function(){var searchResultsUrl="./v4-search-results",url=searchResultsUrl+this.getSearchQueryString();return url},SearchPageController.prototype.getSearchQueryString=function(){var url="?q="+encodeURIComponent(this.params.q);return this.params.page>1&&(url+="&page="+this.params.page),this.params.categories.length>0&&(url+="&categories="+encodeURIComponent(this.params.categories.join(","))),this.params.domains.length>0&&(url+="&domains="+encodeURIComponent(this.params.domains.join(","))),this.params.tags.length>0&&(url+="&tags="+encodeURIComponent(this.params.tags.join(","))),this.params.ec&&(url+="&ec=1"),this.params.ed&&(url+="&ed=1"),this.params.et&&(url+="&et=1"),url},SearchPageController.prototype.incrementPage=function(){this.params.page++},SearchPageController.prototype.navigate=function(){window.location.href=this.getSearchPageUrl()},SearchPageController.prototype.removeRegion=function(regionIndex){this.params.regions.splice(regionIndex,1),this.params.page=1},SearchPageController.prototype.setAutoCompletedRegion=function(region){this.params.autoCompletedRegion=region,this.params.page=1},SearchPageController.prototype.drawPopulationCharts=function(){google.setOnLoadCallback(function(){var apiController=new ApiController,regionIds=self.params.regions.map(function(region){return region.id});apiController.getPopulationDatas(regionIds,function(data){self.drawPopulationChart(regionIds,data),self.drawPopulationChangeChart(regionIds,data)})})},SearchPageController.prototype.drawPopulationChart=function(regionIds,data){for(var year,years=[],i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,years.push(year)),year[m+1]=parseInt(data[i].population)}for(var header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=self.params.regions[i].name;years.unshift(header);var dataTable=google.visualization.arrayToDataTable(years),options={curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population"},chart=new google.visualization.LineChart(document.getElementById("population-chart"));chart.draw(dataTable,options)},SearchPageController.prototype.drawPopulationChangeChart=function(regionIds,data){for(var year,years=[],i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,years.push(year)),year[m+1]=parseFloat(data[i].population_percent_change)/100}for(var header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=self.params.regions[i].name;years.unshift(header);var dataTable=google.visualization.arrayToDataTable(years),options={curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population Change",vAxis:{format:"percent"}},chart=new google.visualization.LineChart(document.getElementById("population-change-chart"));chart.draw(dataTable,options)};