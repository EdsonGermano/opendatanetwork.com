function SearchPageController(params){this.params=params,this.fetching=!1,this.fetchedAll=!1;var self=this;$("section.refine .fa-times-circle").click(function(){self.removeRegion($(this).parent().index()),self.navigate()}),$(window).on("scroll",function(){var bottomOffsetToBeginRequest=1e3;$(window).scrollTop()>=$(document).height()-$(window).height()-bottomOffsetToBeginRequest&&self.fetchNextPage()}).scroll(),$(".fa-search").click(function(){$(".summary").toggle(),$(".text-entry").toggle(),$(".text-entry input").select();var o=$(".fa-search");o.hasClass("selected")?o.removeClass("selected"):o.addClass("selected")})}SearchPageController.prototype.decrementPage=function(){this.params.page--},SearchPageController.prototype.drawLineChart=function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.LineChart(document.getElementById(chartId));chart.draw(dataTable,options)},SearchPageController.prototype.drawSteppedAreaChart=function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.SteppedAreaChart(document.getElementById(chartId));chart.draw(dataTable,options)},SearchPageController.prototype.drawEarningsChart=function(regionIds,data){for(var earnings=[],lessThanHighSchoolEarnings=["Some High School"],i=0;i<regionIds.length;i++)lessThanHighSchoolEarnings[i+1]=parseInt(data[i].median_earnings_less_than_high_school);earnings.push(lessThanHighSchoolEarnings);for(var highSchoolEarnings=["High School"],i=0;i<regionIds.length;i++)highSchoolEarnings[i+1]=parseInt(data[i].median_earnings_high_school);earnings.push(highSchoolEarnings);for(var someCollegeEarnings=["Some College"],i=0;i<regionIds.length;i++)someCollegeEarnings[i+1]=parseInt(data[i].median_earnings_some_college_or_associates);earnings.push(someCollegeEarnings);for(var bachelorsEarnings=["Bachelor's"],i=0;i<regionIds.length;i++)bachelorsEarnings[i+1]=parseInt(data[i].median_earnings_bachelor_degree);earnings.push(bachelorsEarnings);for(var graduateDegreeEarnings=["Graduate Degree"],i=0;i<regionIds.length;i++)graduateDegreeEarnings[i+1]=parseInt(data[i].median_earnings_graduate_or_professional_degree);earnings.push(graduateDegreeEarnings);for(var header=["Education Level"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;earnings.unshift(header),SearchPageController.prototype.drawSteppedAreaChart("earnings-chart",earnings,{areaOpacity:0,connectSteps:!0,curveType:"function",focusTarget:"category",legend:{position:"bottom"},title:"Earnings by Education Level",vAxis:{format:"currency"}})},SearchPageController.prototype.drawEarningsCharts=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getEarningsData(regionIds,function(data){self.drawEarningsChart(regionIds,data),self.drawEarningsTable(regionIds,data)})})},SearchPageController.prototype.drawEarningsTable=function(regionIds,data){var s="";s+="<tr><th></th>";for(var i=0;i<regionIds.length;i++)s+="<th>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td>Median Earnings (All Workers)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Female Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].female_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Male Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].male_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr>",$("#earnings-table").html(s)},SearchPageController.prototype.drawPopulationChart=function(regionIds,data){for(var year,years=[],i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,years.push(year)),year[m+1]=parseInt(data[i].population)}for(var header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;years.unshift(header),SearchPageController.prototype.drawLineChart("population-chart",years,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population"})},SearchPageController.prototype.drawPopulationChangeChart=function(regionIds,data){for(var year,years=[],i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,years.push(year)),year[m+1]=parseFloat(data[i].population_percent_change)/100}for(var header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;years.unshift(header),SearchPageController.prototype.drawLineChart("population-change-chart",years,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population Change",vAxis:{format:"percent"}})},SearchPageController.prototype.drawPopulationCharts=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getPopulationData(regionIds,function(data){self.drawPopulationChart(regionIds,data),self.drawPopulationChangeChart(regionIds,data)})})},SearchPageController.prototype.fetchNextPage=function(){this.fetching||this.fetchedAll||(this.fetching=!0,this.incrementPage(),$.ajax(this.getSearchResultsUrl()).done(function(data,textStatus,jqXHR){return console.log(jqXHR.status+" "+textStatus),204==jqXHR.status?(self.decrementPage(),self.fetching=!1,void(self.fetchedAll=!0)):($(".datasets").append(data),void(self.fetching=!1))}))},SearchPageController.prototype.getSearchPageUrl=function(){var url;if(this.params.regions.length>0||null!=this.params.autoCompletedRegion){url="/";var regionNames=this.params.regions.map(function(region){return region.name.replace(/,/g,"").replace(/ /g,"_")});null!=this.params.autoCompletedRegion&&(console.log(this.params.autoCompletedRegion),regionNames.push(this.params.autoCompletedRegion.replace(/,/g,"").replace(/ /g,"_"))),url+=regionNames.join("_vs_")}else url="/v4-search";return url+=this.getSearchQueryString()},SearchPageController.prototype.getSearchResultsUrl=function(){var searchResultsUrl="./v4-search-results",url=searchResultsUrl+this.getSearchQueryString();return url},SearchPageController.prototype.getSearchQueryString=function(){var url="?q="+encodeURIComponent(this.params.q);return this.params.page>1&&(url+="&page="+this.params.page),this.params.categories.length>0&&(url+="&categories="+encodeURIComponent(this.params.categories.join(","))),this.params.domains.length>0&&(url+="&domains="+encodeURIComponent(this.params.domains.join(","))),this.params.tags.length>0&&(url+="&tags="+encodeURIComponent(this.params.tags.join(","))),this.params.ec&&(url+="&ec=1"),this.params.ed&&(url+="&ed=1"),this.params.et&&(url+="&et=1"),url},SearchPageController.prototype.incrementPage=function(){this.params.page++},SearchPageController.prototype.navigate=function(){window.location.href=this.getSearchPageUrl()},SearchPageController.prototype.removeRegion=function(regionIndex){this.params.regions.splice(regionIndex,1),this.params.page=1},SearchPageController.prototype.setAutoCompletedRegion=function(region){this.params.autoCompletedRegion=region,this.params.page=1};