function SearchPageController(params){this.params=params,this.fetching=!1,this.fetchedAll=!1,this.mostSimilar=[];var self=this;$(".fa-search").click(function(){$(".summary").toggle(),$(".text-entry").toggle(),$(".text-entry input").select(),$(".fa-search").toggleClass("selected-icon")}),$("section.refine .fa-times-circle").click(function(){self.removeRegion($(this).parent().index()),self.navigate()}),$(window).on("scroll",function(){var bottomOffsetToBeginRequest=1e3;$(window).scrollTop()>=$(document).height()-$(window).height()-bottomOffsetToBeginRequest&&self.fetchNextPage()}).scroll(),new AutoSuggestRegionController('.add-region input[type="text"]',".add-region ul",function(region){self.setAutoSuggestedRegion(region),self.navigate()}),$(".add-region .fa-plus").click(function(){$('.add-region input[type="text"]').focus()}),this.drawSimilarRegions(function(region){self.setAutoSuggestedRegion(region),self.navigate()})}SearchPageController.prototype.decrementPage=function(){this.params.page--},SearchPageController.prototype.drawCostOfLivingData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getCostOfLivingData(regionIds,function(data){self.drawCostOfLivingChart(regionIds,data),self.drawCostOfLivingTable(regionIds,data)})})},SearchPageController.prototype.drawCostOfLivingChart=function(regionIds,data){this.drawCostOfLivingChartForComponent("cost-of-living-all-chart","All",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-goods-chart","Goods",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-rents-chart","Rents",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-other-chart","Other",regionIds,data)},SearchPageController.prototype.drawCostOfLivingChartForComponent=function(id,component,regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)data[i].component==component&&(void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].index)));for(var key in o)chartData.push(o[key]);SearchPageController.prototype.drawLineChart(id,chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:component})},SearchPageController.prototype.drawCostOfLivingTable=function(regionIds,data){for(var components=["All","Goods","Other","Rents"],rows=[],i=0;i<components.length;i++){for(var component=components[i],row=[component],j=0;j<regionIds.length;j++){var o=this.getLatestCostOfLiving(data,regionIds[j],component);row.push({index:null!=o?parseFloat(o.index):"NA",percentile:null!=o?this.getPercentile(o.rank,o.total_ranks):"NA"})}rows.push(row)}for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Value</td><td class='column-header'>Percentile</td>";s+="</tr>";for(var i=0;i<rows.length;i++){var row=rows[i];s+="<tr>",s+="<td>"+row[0]+"</td>";for(var j=1;j<row.length;j++)s+="<td>"+row[j].index+"</td>",s+="<td>"+row[j].percentile+"</td>";s+="</tr>"}$("#cost-of-living-table").html(s)},SearchPageController.prototype.getPercentile=function(rank,totalRanks){var totalRanks=parseInt(totalRanks),rank=parseInt(rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);return numeral(percentile).format("0o")},SearchPageController.prototype.getLatestCostOfLiving=function(data,regionId,component){for(var datum=null,i=0;i<data.length;i++)data[i].id==regionId&&data[i].component==component&&(null!=datum?parseInt(data[i].year)<=parseInt(datum.year)||(datum=data[i]):datum=data[i]);return datum},SearchPageController.prototype.drawEarningsData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getEarningsData(regionIds,function(data){self.drawEarningsChart(regionIds,data),self.drawEarningsTable(regionIds,data)})})},SearchPageController.prototype.drawEarningsChart=function(regionIds,data){for(var earnings=[],header=["Education Level"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;earnings.push(header);for(var someHighSchoolEarnings=["Some High School"],i=0;i<regionIds.length;i++)someHighSchoolEarnings[i+1]=parseInt(data[i].median_earnings_less_than_high_school);earnings.push(someHighSchoolEarnings);for(var highSchoolEarnings=["High School"],i=0;i<regionIds.length;i++)highSchoolEarnings[i+1]=parseInt(data[i].median_earnings_high_school);earnings.push(highSchoolEarnings);for(var someCollegeEarnings=["Some College"],i=0;i<regionIds.length;i++)someCollegeEarnings[i+1]=parseInt(data[i].median_earnings_some_college_or_associates);earnings.push(someCollegeEarnings);for(var bachelorsEarnings=["Bachelor's"],i=0;i<regionIds.length;i++)bachelorsEarnings[i+1]=parseInt(data[i].median_earnings_bachelor_degree);earnings.push(bachelorsEarnings);for(var graduateDegreeEarnings=["Graduate Degree"],i=0;i<regionIds.length;i++)graduateDegreeEarnings[i+1]=parseInt(data[i].median_earnings_graduate_or_professional_degree);earnings.push(graduateDegreeEarnings),SearchPageController.prototype.drawSteppedAreaChart("earnings-chart",earnings,{areaOpacity:0,connectSteps:!0,curveType:"function",focusTarget:"category",legend:{position:"bottom"},title:"Earnings by Education Level",vAxis:{format:"currency"}})},SearchPageController.prototype.drawEarningsTable=function(regionIds,data){var s="";s+="<tr><th></th>";for(var i=0;i<regionIds.length;i++)s+="<th>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td>Median Earnings (All Workers)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Female Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].female_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Male Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].male_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr>",$("#earnings-table").html(s)},SearchPageController.prototype.drawEducationData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getEducationData(regionIds,function(data){self.drawEducationTable(regionIds,data)})})},SearchPageController.prototype.drawEducationTable=function(regionIds,data){var s="";s+="<tr><th></th>";for(var i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Percent</td><td class='column-header'>Percentile</td>";s+="</tr><tr><td>At Least Bachelor's Degree</td>";for(var i=0;i<regionIds.length;i++){var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_bachelors_degree_or_higher_rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+data[i].percent_bachelors_degree_or_higher+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr><tr><td>At Least High School Diploma</td>";for(var i=0;i<regionIds.length;i++){var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_high_school_graduate_or_higher),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+data[i].percent_high_school_graduate_or_higher+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr>",$("#education-table").html(s)},SearchPageController.prototype.drawGdpData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getGdpData(regionIds,function(data){self.drawGdpChart(regionIds,data),self.drawGdpChangeChart(regionIds,data)})})},SearchPageController.prototype.drawGdpChart=function(regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].per_capita_gdp));for(var key in o)chartData.push(o[key]);SearchPageController.prototype.drawLineChart("per-capita-gdp-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Per Capita Real GDP over Time"})},SearchPageController.prototype.drawGdpChangeChart=function(regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].per_capita_gdp_percent_change)/100);for(var key in o)chartData.push(o[key]);SearchPageController.prototype.drawLineChart("per-capita-gdp-change-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Annual Change in Per Capita GDP over Time",vAxis:{format:"#.#%"}})},SearchPageController.prototype.drawOccupationsData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getOccupationsData(regionIds,function(data){self.drawOccupationsTable(regionIds,data)})})},SearchPageController.prototype.drawOccupationsTable=function(regionIds,data){for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Percent</td><td class='column-header'>Percentile</td>";for(var i=0;i<data.length;i++){i%regionIds.length==0&&(s+="</tr><tr><td>"+data[i].occupation+"</td>");var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_employed_rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+numeral(data[i].percent_employed).format("0.0")+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr>",$("#occupations-table").html(s)},SearchPageController.prototype.drawPopulationData=function(){var self=this;google.setOnLoadCallback(function(){var regionIds=self.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getPopulationData(regionIds,function(data){self.drawPopulationChart(regionIds,data),self.drawPopulationChangeChart(regionIds,data)})})},SearchPageController.prototype.drawPopulationChart=function(regionIds,data){for(var year,chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,chartData.push(year)),year[m+1]=parseInt(data[i].population)}SearchPageController.prototype.drawLineChart("population-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population"})},SearchPageController.prototype.drawPopulationChangeChart=function(regionIds,data){for(var year,chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,chartData.push(year)),year[m+1]=parseFloat(data[i].population_percent_change)/100}SearchPageController.prototype.drawLineChart("population-change-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population Change",vAxis:{format:"#.#%"}})},SearchPageController.prototype.drawSimilarRegions=function(onClickRegion){if(0!=this.params.length){for(var region=null,i=0;i<this.params.regions.length;i++)if("msa"!=this.params.regions[i].type){region=this.params.regions[i];break}if(null!=region){var controller=new ApiController,self=this;controller.getSimilarRegions(region.id,function(data){self.drawSimilarRegionsList(data,onClickRegion)})}}},SearchPageController.prototype.drawSimilarRegionsList=function(data,onClickRegion){var s="";if(void 0!=data.most_similar){this.mostSimilar=data.most_similar;for(var i=0;i<this.mostSimilar.length;i++)s+='<li><span><i class="fa"></i></span>'+this.mostSimilar[i].name+"</li>";$(".similar-regions").html(s),$(".similar-regions").slideToggle(100);var self=this;$(".similar-regions li span").click(function(){$(this).children(":first").addClass("fa-check");var index=$(this).parent().index();onClickRegion(self.mostSimilar[index].name)})}},SearchPageController.prototype.drawLineChart=function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.LineChart(document.getElementById(chartId));chart.draw(dataTable,options)},SearchPageController.prototype.drawSteppedAreaChart=function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.SteppedAreaChart(document.getElementById(chartId));chart.draw(dataTable,options)},SearchPageController.prototype.fetchNextPage=function(){this.fetching||this.fetchedAll||(this.fetching=!0,this.incrementPage(),$.ajax(this.getSearchResultsUrl()).done(function(data,textStatus,jqXHR){return console.log(jqXHR.status+" "+textStatus),204==jqXHR.status?(self.decrementPage(),self.fetching=!1,void(self.fetchedAll=!0)):($(".datasets").append(data),void(self.fetching=!1))}))},SearchPageController.prototype.getSearchPageUrl=function(){var url;if(this.params.regions.length>0||null!=this.params.autoSuggestedRegion){url="/";var regionNames=this.params.regions.map(function(region){return region.name.replace(/,/g,"").replace(/ /g,"_")});null!=this.params.autoSuggestedRegion&&regionNames.push(this.params.autoSuggestedRegion.replace(/,/g,"").replace(/ /g,"_")),url+=regionNames.join("_vs_"),this.params.vector&&(url+="/"+this.params.vector)}else url="/v4-search";return url+=this.getSearchQueryString()},SearchPageController.prototype.getSearchResultsUrl=function(){var searchResultsUrl="./v4-search-results",url=searchResultsUrl+this.getSearchQueryString();return url},SearchPageController.prototype.getSearchQueryString=function(){var url="?q="+encodeURIComponent(this.params.q);return this.params.page>1&&(url+="&page="+this.params.page),this.params.categories.length>0&&(url+="&categories="+encodeURIComponent(this.params.categories.join(","))),this.params.domains.length>0&&(url+="&domains="+encodeURIComponent(this.params.domains.join(","))),this.params.tags.length>0&&(url+="&tags="+encodeURIComponent(this.params.tags.join(","))),this.params.ec&&(url+="&ec=1"),this.params.ed&&(url+="&ed=1"),this.params.et&&(url+="&et=1"),url},SearchPageController.prototype.incrementPage=function(){this.params.page++},SearchPageController.prototype.navigate=function(){window.location.href=this.getSearchPageUrl()},SearchPageController.prototype.removeRegion=function(regionIndex){this.params.regions.splice(regionIndex,1),this.params.page=1},SearchPageController.prototype.setAutoSuggestedRegion=function(region){this.params.autoSuggestedRegion=region,this.params.page=1};