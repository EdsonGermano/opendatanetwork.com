"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function multiComplete(inputSelector,resultSelector){function autocompleteURL(domain,fxf,column){return function(query){return"https://"+domain+"/views/"+fxf+"/columns/"+column+"/suggest/"+query+"?size=5"}}function navigate(path){window.location.href=path}var domain="odn.data.socrata.com",inputSelection=d3.select(inputSelector),resultSelection=d3.select(resultSelector),datasetURL=autocompleteURL(domain,"fpum-bjbr","name"),datasetSelect=function(dataset){return navigate("/search?q="+dataset)},datasetResults=new Results("Datasets",resultSelection,datasetSelect),datasetComplete=new Complete(datasetURL,datasetResults),regionURL=autocompleteURL(domain,"7g2b-8brv","autocomplete_name"),regionSelect=function(region){return navigate("/"+region.replace(/ /g,"_"))},regionResults=new Results("Regions",resultSelection,regionSelect),regionComplete=new Complete(regionURL,regionResults),publisherURL=autocompleteURL(domain,"8ae5-ghum","domain"),publisherSelect=function(publisher){return navigate("/search?domains="+publisher)},publisherResults=new Results("Publishers",resultSelection,publisherSelect),publisherComplete=new Complete(publisherURL,publisherResults),categoryURL=autocompleteURL(domain,"864v-r7tf","category"),categorySelect=function(category){return navigate("/search?categories="+category)},categoryResults=new Results("Categories",resultSelection,categorySelect),categoryComplete=new Complete(categoryURL,categoryResults),completers=[datasetComplete,regionComplete,publisherComplete,categoryComplete];return new AutoSuggestRegionController(inputSelection,resultSelection,completers)}var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i["return"]&&_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();$(document).ready(function(){$(".search-link").click(function(){var text=$("#q").val().trim();0==text.length?$("#q").focus():$("#form").submit()})}),Array.prototype.includes=function(s){return this.indexOf(s)>-1},String.prototype.format=function(){var args=arguments;return this.replace(/{(\d+)}/g,function(match,number){return"undefined"!=typeof args[number]?args[number]:match})},String.prototype.split2=function(s){var rg=this.split(s);return 1==rg.length&&""==rg[0]?[]:rg};var ApiController=function(){function ApiController(){_classCallCheck(this,ApiController),this.autoCompleteNameSuggestUrl="https://odn.data.socrata.com/views/7g2b-8brv/columns/autocomplete_name/suggest/{0}?size=10&fuzz=0",this.categoriesUrl="/categories.json",this.childRegionsUrl="https://odn.data.socrata.com/resource/eyae-8jfy?parent_id={0}&$limit={1}",this.costOfLivingUrl="https://odn.data.socrata.com/resource/hpnf-gnfu.json?$order=name&$where=",this.domainsUrl="https://api.us.socrata.com/api/catalog/v1/domains",this.earningsByPlaceUrl="https://odn.data.socrata.com/resource/wmwh-4vak.json/?type=place&$limit=50000&$where=population%20%3E%205000",this.earningsUrl="https://odn.data.socrata.com/resource/wmwh-4vak.json?$where=",this.educationByPlaceUrl="https://odn.data.socrata.com/resource/uf4m-5u8r.json?type=place&$limit=50000&$where=population%20%3E%205000",this.educationUrl="https://odn.data.socrata.com/resource/uf4m-5u8r.json?$where=",this.gdpUrl="https://odn.data.socrata.com/resource/ks2j-vhr8.json?$where=",this.mostPopulousRegionTypeUrl="https://odn.data.socrata.com/resource/eyae-8jfy?parent_id={0}&child_type={1}&$limit={2}&$order=child_population desc",this.occupationsByPlaceUrl="https://odn.data.socrata.com/resource/qfcm-fw3i.json?occupation={0}&type=place&$limit=50000&$where=population%20%3E%205000",this.occupationsUrl="https://odn.data.socrata.com/resource/qfcm-fw3i.json?$order=occupation&$where=",this.parentStateUrl="https://odn.data.socrata.com/resource/eyae-8jfy?parent_type=state&child_id={0}",this.placesUrl="https://odn.data.socrata.com/resource/gm3u-gw57.json/?type=place&$limit=50000&$where=population%20%3E%205000",this.populationUrl="https://odn.data.socrata.com/resource/e3rd-zzmr.json?$order=year,name&$where=",this.similarRegionsUrl="https://socrata-peers.herokuapp.com/peers.json?vectors=population_change,earnings,occupation,education,population&n=10&id={0}",this.healthDataUrls={rwjf_county_health_rankings_2015:"https://odn.data.socrata.com/resource/7ayp-utp2.json?$where=",cdc_brfss_prevalence_2011_2013:"https://odn.data.socrata.com/resource/n4rt-3rmd.json?$where="}}return _createClass(ApiController,[{key:"getAutoCompleteNameSuggestions",value:function(searchTerm){return d3.promise.json(this.autoCompleteNameSuggestUrl.format(encodeURIComponent(searchTerm)))}},{key:"getCategories",value:function(){return d3.promise.json(this.categoriesUrl)}},{key:"getChildRegions",value:function(regionId){var limit=arguments.length<=1||void 0===arguments[1]?10:arguments[1];return d3.promise.json(this.childRegionsUrl.format(regionId,limit))}},{key:"getCitiesInState",value:function(stateId){var limit=arguments.length<=1||void 0===arguments[1]?10:arguments[1];return d3.promise.json(this.mostPopulousRegionTypeUrl.format(stateId,"place",limit))}},{key:"getCostOfLivingData",value:function(regionIds){return this.getData(this.costOfLivingUrl,regionIds)}},{key:"getCountiesInState",value:function(stateId){var limit=arguments.length<=1||void 0===arguments[1]?10:arguments[1];return d3.promise.json(this.mostPopulousRegionTypeUrl.format(stateId,"county",limit))}},{key:"getData",value:function(url,regionIds){var segments=regionIds.map(function(regionId){return"id='"+regionId+"'"});return d3.promise.json(url+encodeURI(segments.join(" OR ")))}},{key:"getDomains",value:function(){return d3.promise.json(this.domainsUrl)}},{key:"getEarningsByPlace",value:function(){return d3.promise.json(this.earningsByPlaceUrl)}},{key:"getEarningsData",value:function(regionIds){return this.getData(this.earningsUrl,regionIds)}},{key:"getEducationByPlace",value:function(){return d3.promise.json(this.educationByPlaceUrl)}},{key:"getEducationData",value:function(regionIds){return this.getData(this.educationUrl,regionIds)}},{key:"getGdpData",value:function(regionIds){return this.getData(this.gdpUrl,regionIds)}},{key:"getMetrosInState",value:function(stateId){var limit=arguments.length<=1||void 0===arguments[1]?10:arguments[1];return d3.promise.json(this.mostPopulousRegionTypeUrl.format(stateId,"msa",limit))}},{key:"getOccupationsByPlace",value:function(occupation){return d3.promise.json(this.occupationsByPlaceUrl.format(occupation))}},{key:"getOccupationsData",value:function(regionIds){return this.getData(this.occupationsUrl,regionIds)}},{key:"getParentState",value:function(region){return d3.promise.json(this.parentStateUrl.format(region.id))}},{key:"getPopulationData",value:function(regionIds){return this.getData(this.populationUrl,regionIds)}},{key:"getPlaces",value:function(){return d3.promise.json(this.placesUrl)}},{key:"getSimilarRegions",value:function(regionId){return d3.promise.json(this.similarRegionsUrl.format(regionId))}},{key:"getHealthRwjfChrData",value:function(regionIds){return this.getData(this.healthDataUrls.rwjf_county_health_rankings_2015,regionIds)}}]),ApiController}(),Constants={ROSTER_URL:"https://federal.demo.socrata.com/resource/7g2b-8brv.json",LIMIT:5e4},RegionLookup=function(){function RegionLookup(){_classCallCheck(this,RegionLookup)}return _createClass(RegionLookup,null,[{key:"get",value:function(params){return $.getJSON(Constants.ROSTER_URL+"?"+$.param(params))}},{key:"getOne",value:function(params){function selectRegion(regions){if(0===regions.length)return console.warn("no regions found for params: "),console.warn(params),null;if(1===regions.length)return regions[0];var places=_.filter(regions,function(region){return"place"===region.type});return places.length>0?places[0]:regions[0]}return new Promise(function(resolve,reject){RegionLookup.get(params).then(function(regions){resolve(selectRegion(regions))},function(error){throw error})})}},{key:"byName",value:function(name){return RegionLookup.getOne({name:name})}},{key:"byID",value:function(id){return RegionLookup.getOne({id:id})}},{key:"byAutocompleteName",value:function(name){return RegionLookup.getOne({autocomplete_name:name})}}]),RegionLookup}(),Complete=function(){function Complete(queryBuilder,results){_classCallCheck(this,Complete),this.queryBuilder=queryBuilder,this.results=results}return _createClass(Complete,[{key:"get",value:function(query){return""==query?[]:void this.results.handle($.getJSON(this.queryBuilder(query)))}}]),Complete}(),Results=function(){function Results(type,resultSelection,onSelect){_classCallCheck(this,Results),this.type=type,this.onSelect=onSelect,this.container=resultSelection.append("div").attr("class","autocomplete-results-container").style("display","none"),this.title=this.container.append("p").attr("class","autocomplete-results-title").text(this.type),this.results=this.container.append("div").attr("class","autocomplete-results")}return _createClass(Results,[{key:"hide",value:function(){this.container.style("display","none")}},{key:"unhide",value:function(){this.container.style("display","block")}},{key:"empty",value:function(){this.results.html("")}},{key:"handle",value:function(resultsPromise){var _this=this,success=function(results){_this.empty();var options=results.options;0==options.length?_this.hide():(_this.unhide(),_this.show(options))},failure=function(error){throw error};resultsPromise.then(success,failure)}},{key:"show",value:function(options){var _this2=this;this.results.selectAll("li").data(options).enter().append("li").html(function(option){return option.text}).on("mouseover",function(){d3.select(this).classed("selected",!0)}).on("mouseout",function(){d3.select(this).classed("selected",!1)}).on("click",function(option){_this2.onSelect(option.text)})}}]),Results}(),AutoSuggestRegionController=function(){function AutoSuggestRegionController(inputSelection,resultSelection,completers){_classCallCheck(this,AutoSuggestRegionController),this.inputSelection=inputSelection,this.resultSelection=resultSelection,this.completers=completers}return _createClass(AutoSuggestRegionController,[{key:"listen",value:function(){var self=this;self.inputSelection.on("input",function(){self.suggest(this.value)})}},{key:"navigate",value:function(path){window.location.href=path}},{key:"suggest",value:function(term){""==term?this.resultSelection.style("display","none"):(this.resultSelection.style("display","block"),this.completers.forEach(function(completer){completer.get(term)}))}}]),AutoSuggestRegionController}(),sourceComplete=function(){function urlFor(column){return function(query){return"https://"+domain+"/views/"+fxf+"/columns/"+column+"/suggest/"+query+"?size=5"}}var domain="odn.data.socrata.com",fxf="pfgp-ifph",nameToColumn=new Map;nameToColumn.set("population","population"),nameToColumn.set("earnings","earnings"),nameToColumn.set("education","education"),nameToColumn.set("occupations","occupations"),nameToColumn.set("cost_of_living","rpp"),nameToColumn.set("gdp","gdp");var defaultColumn="population";return function(inputSelector,resultSelector,name,select){var inputSelection=d3.select(inputSelector),resultSelection=d3.select(resultSelector),column=nameToColumn.has(name)?nameToColumn.get(name):defaultColumn,url=urlFor(column),results=new Results("Regions with Data",resultSelection,select),complete=new Complete(url,results);return new AutoSuggestRegionController(inputSelection,resultSelection,[complete])}}(),Scale=function(){function Scale(values,range,scale){_classCallCheck(this,Scale),this.values=values,this.range=range,this.scale=scale}return _createClass(Scale,null,[{key:"quantile",value:function(values,range){values.sort(d3.ascending);var step=1/range.length,domain=_.map(range.slice(1),function(value,index){return d3.quantile(values,(index+1)*step)}),scale=d3.scale.quantile().domain(domain).range(range);return new Scale(values,range,scale)}}]),Scale}(),MapConstants={BASE_LAYER_URL:"https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png",BASE_LAYER_OPACITY:.5,COLOR_SCALE:colorbrewer.RdYlBu[9],SCALE:Scale.quantile,ATTRIBUTION:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',INITIAL_CENTER:[37.1669,-95.9669],BOUNDS_SOUTH_WEST:[18.9117,-179.1506],BOUNDS_NORTH_EAST:[71.441,-66.9406],MIN_ZOOM:3,MAX_ZOOM:12,INITIAL_ZOOM:4,PLACE_ZOOM:10,AUTOZOOM_PADDING:100,REGION_BORDER_COLOR:"#34495e",REGION_BORDER_WEIGHT:1,REGION_FILL_OPACITY:1,REFERENCE_BORDER_COLOR:"#2c3e50",REFERENCE_BORDER_WEIGHT:2,POINT_RADIUS_RANGE_METERS:[500,2e3],POINT_FILL_OPACITY:1,LOADING_TOOLTIP_NAME:"Loading",REGION_SELECT_WIDTH:150,VARIABLE_SELECT_WIDTH:300,OPTIONS:{scrollWheelZoom:!1,bounceAtZoomLimits:!1},GAZETTEER_URL:"https://federal.demo.socrata.com/resource/gm3u-gw57.json",ROSTER_URL:"https://federal.demo.socrata.com/resource/7g2b-8brv.json",TOPOJSON_DIRECTORY:"geo/",TOPOJSON_SUFFIX:".topo.json",REGIONS:{nation:{name:"USA",id:"nation",topo:"nation"},region:{name:"Regions",id:"region",topo:"region"},division:{name:"Divisions",id:"division",topo:"division"},state:{name:"States",id:"state",topo:"state"},county:{name:"Counties",id:"county",topo:"county"},msa:{name:"Metros",id:"msa",topo:"cbsa"},place:{name:"Cities",id:"place",topo:"state"}}},TopoModel=function(){function TopoModel(){_classCallCheck(this,TopoModel)}return _createClass(TopoModel,null,[{key:"get",value:function(region){var url=MapConstants.TOPOJSON_DIRECTORY+region.topo+MapConstants.TOPOJSON_SUFFIX;return $.getJSON(url)}}]),TopoModel}(),MapModel=function(){function MapModel(source,region,variable,regions){_classCallCheck(this,MapModel),this.source=source,this.region=region,this.variable=variable,this.regions=regions,this.regionById=MapModel.makeLookup(regions,function(region){return region.id})}return _createClass(MapModel,[{key:"values",value:function(){return this.regions.map(function(region){return region.value})}},{key:"scale",value:function(scaleFunction,range){return this.variable.reverse&&range.reverse(),scaleFunction(this.values(),range)}}],[{key:"makeLookup",value:function(list,key){var lookup=new Map;return _.each(list,function(element){return lookup.set(key(element),element)}),lookup}},{key:"create",value:function(source,region,variable){return new Promise(function(resolve,reject){function success(results){var regions=results.map(function(region){var value=variable.value(region[variable.column]);return{id:region.id,type:region.type,name:region.name,value:value,valueName:variable.name,valueFormatted:variable.format(value)}});resolve(new MapModel(source,region,variable,regions))}function failure(error){throw error}var baseParams={type:region.id,$select:["id","type","name"].concat([variable.column]).join(),$limit:Constants.LIMIT},params=_.extend({},baseParams,variable.params),url="https://"+source.domain+"/resource/"+source.fxf+".json?"+$.param(params);$.getJSON(url).then(success,failure)})}}]),MapModel}(),MapView=function(){function MapView(map,model,topoLayers,container,legend,tooltip){_classCallCheck(this,MapView),this.map=map,this.model=model,this.scale=model.scale(MapConstants.SCALE,MapConstants.COLOR_SCALE),this.topoLayers=topoLayers,this.container=container,this.legend=legend,this.tooltip=tooltip}return _createClass(MapView,[{key:"display",value:function(){this.drawLayers(),this.drawScale()}},{key:"drawScale",value:function(){this.legend.update(this.scale,this.model.variable)}},{key:"drawLayers",value:function(){var _this3=this,styleLayer=function(layer){var id=layer.feature.id;if(_this3.model.regionById.has(id))!function(){var region=_this3.model.regionById.get(id),style={stroke:!0,color:MapConstants.REGION_BORDER_COLOR,weight:MapConstants.REGION_BORDER_WEIGHT,fillColor:_this3.scale.scale(region.value),fillOpacity:MapConstants.REGION_FILL_OPACITY},events={mouseover:function(){return _this3.tooltip.showRegion(region)},mouseout:function(){return _this3.tooltip.hide()}};layer.setStyle(style),layer.on(events)}();else{var style={stroke:!0,color:MapConstants.REFERENCE_BORDER_COLOR,weight:MapConstants.REFERENCE_BORDER_WEIGHT,fill:!1,clickable:!1};layer.setStyle(style)}};this.topoLayers.eachLayer(styleLayer)}},{key:"remove",value:function(){}}]),MapView}(),MapContainer=function(){function MapContainer(selector,topology){_classCallCheck(this,MapContainer),this.selection=d3.select(selector),this.topology=topology,this.topoLayer=omnivore.topojson.parse(topology),this.legend=new LegendControl,this.tooltip=new TooltipControl,this.map=this.createMap()}return _createClass(MapContainer,[{key:"createMap",value:function(){var id="leaflet-map",map=(this.selection.append("div").attr("class","map-container").attr("id",id),L.map(id,{minZoom:MapConstants.MIN_ZOOM,maxZoom:MapConstants.MAX_ZOOM}));return map.setView(MapConstants.INITIAL_CENTER,MapConstants.INITIAL_ZOOM),L.tileLayer(MapConstants.BASE_LAYER_URL,{opacity:MapConstants.BASE_LAYER_OPACITY,attribution:MapConstants.ATTRIBUTION}).addTo(map),map.addControl(this.legend),map.addControl(this.tooltip),map.addLayer(this.topoLayer),map}},{key:"display",value:function(model){var view=new MapView(this.map,model,this.topoLayer,this.selection,this.legend,this.tooltip);view.display()}}]),MapContainer}(),LegendControl=L.Control.extend({options:{position:"bottomleft"},onAdd:function(map){var container=L.DomUtil.create("div","legend-container");return this.container=d3.select(container),container},update:function(scale,variable){this.container.selectAll("*").remove();var legendContainer=this.container.append("div").attr("class","legend-container"),dimension=10,range=scale.range.slice();range.reverse();var height=range.length*dimension,width=200,xOffset=width/2,values=_.filter(scale.values,function(value){return!isNaN(value)}),_d3$extent=d3.extent(values),_d3$extent2=_slicedToArray(_d3$extent,2),min=_d3$extent2[0],max=_d3$extent2[1],lowerQuartile=d3.quantile(values,.25),median=d3.median(values),upperQuartile=d3.quantile(values,.75),tickValues=[max,upperQuartile,median,lowerQuartile,min],tickNames=["maximum","upper quartile","median","lower quartile","minimum"],tickData=_.zip(tickValues,tickNames),tickStep=height/(tickData.length-1),legend=legendContainer.append("svg").attr("width",width).attr("height",height+30+3*dimension).attr("class","legend"),tickGroup=(legend.append("text").attr("class","legend-name").attr("text-anchor","middle").attr("x",xOffset+dimension/2).attr("y",1.2*dimension).text(variable.name),legend.append("g").attr("class","ticks")),ticks=tickGroup.selectAll("g.tick").data(tickData).enter().append("g").attr("class","tick").attr("transform",function(__,index){return"translate("+xOffset+", "+(3*dimension+index*tickStep)+")"});ticks.append("line").attr("class","tick-line").attr("x1",dimension).attr("y1",0).attr("x2",2*dimension).attr("y2",0),ticks.append("line").attr("class","tick-line").attr("x1",-dimension).attr("y1",0).attr("x2",0).attr("y2",0);var baseline="middle",padding=2;ticks.append("text").attr("class","tick-value").text(function(tick){return variable.format(tick[0])}).attr("alignment-baseline",baseline).attr("transform","translate("+(2*dimension+padding)+", 0)"),ticks.append("text").attr("class","tick-label").text(function(tick){return tick[1]}).attr("text-anchor","end").attr("alignment-baseline",baseline).attr("transform","translate("+-(dimension+padding)+", 0)");legend.selectAll("rect").data(range).enter().append("rect").attr("class","legend-element").attr("x",xOffset).attr("y",function(__,index){return(index+3)*dimension}).attr("width",dimension).attr("height",dimension).style("stroke","none").style("fill",function(color){return color});legend.append("rect").attr("class","legend-box").attr("x",xOffset).attr("y",3*dimension).attr("width",dimension).attr("height",height)}}),TooltipControl=L.Control.extend({options:{position:"topright"},onAdd:function(map){var containerDiv=L.DomUtil.create("div","tooltip");return this.container=d3.select(containerDiv),this.name=this.container.append("div").attr("class","name"),this.value=this.container.append("div").attr("class","value"),containerDiv},show:function(name,value){this.name.text(name),this.value.text(value),this.unhide()},showRegion:function(region){this.show(region.name,region.valueName+": "+region.valueFormatted)},hide:function(){this.container.style("display","none")},unhide:function(){this.container.style("display","inline")}}),SearchPageController=function(){function SearchPageController(params){function selectRegion(autocompleteName){RegionLookup.byAutocompleteName(autocompleteName).then(function(region){self.setAutoSuggestedRegion(region.name,!1),self.navigate()},function(error){throw error})}_classCallCheck(this,SearchPageController),this.MAP_COLOR_SCALE=colorbrewer.RdYlBu[9],this.MAP_INITIAL_ZOOM=10,this.MAP_RADIUS_SCALE=[500,2e3],this.params=params,this.fetching=!1,this.fetchedAll=!1,this.mostSimilar=[];var self=this;$(".refine-link").mouseenter(function(){$(this).addClass("refine-link-selected"),$(this).children("span").children("i").removeClass("fa-caret-down").addClass("fa-caret-up"),$(this).children("ul").slideDown(100)}),$(".refine-link").mouseleave(function(){$(this).removeClass("refine-link-selected"),$(this).children("span").children("i").removeClass("fa-caret-up").addClass("fa-caret-down"),$(this).children("ul").slideUp(100)}),this.attachCategoriesClickHandlers(),$("#refine-menu-categories-view-more").click(function(){var controller=new ApiController;controller.getCategories().then(function(data){var rg=data.results.map(function(result){return'<li><i class="fa '+result.metadata.icon+'"></i>'+result.category+"</li>"}),s=rg.join("");$("#refine-menu-categories").html(s),self.attachCategoriesClickHandlers()})["catch"](function(error){return console.error(error)})}),this.attachDomainsClickHandlers(),$("#refine-menu-domains-view-more").click(function(){var controller=new ApiController;controller.getDomains().then(function(data){var rg=data.results.map(function(result){return"<li>"+result.domain+"</li>"}),s=rg.join("");$("#refine-menu-domains").html(s),self.attachDomainsClickHandlers()})["catch"](function(error){return console.error(error)})}),this.attachStandardsClickHandlers(),$(".region-token .fa-times-circle").click(function(){self.removeRegion($(this).parent().index()),self.navigate()}),$(".category-token .fa-times-circle").click(function(){self.toggleCategory($(this).parent().text().toLowerCase().trim()),self.navigate()}),$(".domain-token .fa-times-circle").click(function(){self.toggleDomain($(this).parent().text().toLowerCase().trim()),self.navigate()}),$(".standard-token .fa-times-circle").click(function(){self.toggleStandard($(this).parent().text().toLowerCase().trim()),self.navigate()}),$(window).on("scroll",function(){var bottomOffsetToBeginRequest=1e3;$(window).scrollTop()>=$(document).height()-$(window).height()-bottomOffsetToBeginRequest&&self.fetchNextPage()}).scroll(),sourceComplete(".add-region-input",".add-region-results",this.params.vector,selectRegion).listen(),$(".add-region .fa-plus").click(function(){$('.add-region input[type="text"]').focus()}),this.drawSimilarRegions(function(region){self.setAutoSuggestedRegion(region,!1),self.navigate()}),this.drawPlacesInRegion()}return _createClass(SearchPageController,[{key:"attachCategoriesClickHandlers",value:function(){var self=this;$("#refine-menu-categories li:not(.refine-view-more)").click(function(){self.toggleCategory($(this).text().toLowerCase().trim()),self.navigate()})}},{key:"attachDomainsClickHandlers",value:function(){var self=this;$("#refine-menu-domains li:not(.refine-view-more)").click(function(){var domain=$(this).text().toLowerCase().trim();self.toggleDomain(domain),self.navigate()})}},{key:"attachStandardsClickHandlers",value:function(){var self=this;$("#refine-menu-standards li").click(function(){var standard=$(this).text().toLowerCase().trim();self.toggleStandard(standard),self.navigate()})}},{key:"decrementPage",value:function(){this.params.page--}},{key:"drawCostOfLivingData",value:function(){var _this4=this;google.setOnLoadCallback(function(){var regionIds=_this4.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getCostOfLivingData(regionIds).then(function(data){_this4.drawCostOfLivingChart(regionIds,data),_this4.drawCostOfLivingTable(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawCostOfLivingChart",value:function(regionIds,data){this.drawCostOfLivingChartForComponent("cost-of-living-all-chart","All",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-goods-chart","Goods",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-rents-chart","Rents",regionIds,data),this.drawCostOfLivingChartForComponent("cost-of-living-other-chart","Other",regionIds,data)}},{key:"drawCostOfLivingChartForComponent",value:function(id,component,regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)data[i].component==component&&(void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].index)));for(var key in o)chartData.push(o[key]);this.drawLineChart(id,chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:component})}},{key:"drawCostOfLivingTable",value:function(regionIds,data){for(var components=["All","Goods","Other","Rents"],rows=[],i=0;i<components.length;i++){for(var component=components[i],row=[component],j=0;j<regionIds.length;j++){var o=this.getLatestCostOfLiving(data,regionIds[j],component);row.push({index:null!=o?parseFloat(o.index):"NA",percentile:null!=o?this.getPercentile(o.rank,o.total_ranks):"NA"})}rows.push(row)}for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Value</td><td class='column-header'>Percentile</td>";s+="</tr>";for(var i=0;i<rows.length;i++){var row=rows[i];s+="<tr>",s+="<td>"+row[0]+"</td>";for(var j=1;j<row.length;j++)s+="<td>"+row[j].index+"</td>",s+="<td>"+row[j].percentile+"</td>";s+="</tr>"}$("#cost-of-living-table").html(s)}},{key:"getPercentile",value:function(rank,totalRanks){var totalRanks=parseInt(totalRanks),rank=parseInt(rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);return numeral(percentile).format("0o")}},{key:"getLatestCostOfLiving",value:function(data,regionId,component){for(var datum=null,i=0;i<data.length;i++)data[i].id==regionId&&data[i].component==component&&(null!=datum?parseInt(data[i].year)<=parseInt(datum.year)||(datum=data[i]):datum=data[i]);return datum}},{key:"drawEarningsData",value:function(){var _this5=this;google.setOnLoadCallback(function(){var regionIds=_this5.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getEarningsData(regionIds).then(function(data){_this5.drawEarningsMap(),_this5.drawEarningsChart(regionIds,data),_this5.drawEarningsTable(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawEarningsChart",value:function(regionIds,data){for(var earnings=[],header=["Education Level"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;earnings.push(header);for(var someHighSchoolEarnings=["Some High School"],i=0;i<regionIds.length;i++)someHighSchoolEarnings[i+1]=parseInt(data[i].median_earnings_less_than_high_school);earnings.push(someHighSchoolEarnings);for(var highSchoolEarnings=["High School"],i=0;i<regionIds.length;i++)highSchoolEarnings[i+1]=parseInt(data[i].median_earnings_high_school);earnings.push(highSchoolEarnings);for(var someCollegeEarnings=["Some College"],i=0;i<regionIds.length;i++)someCollegeEarnings[i+1]=parseInt(data[i].median_earnings_some_college_or_associates);earnings.push(someCollegeEarnings);for(var bachelorsEarnings=["Bachelor's"],i=0;i<regionIds.length;i++)bachelorsEarnings[i+1]=parseInt(data[i].median_earnings_bachelor_degree);earnings.push(bachelorsEarnings);for(var graduateDegreeEarnings=["Graduate Degree"],i=0;i<regionIds.length;i++)graduateDegreeEarnings[i+1]=parseInt(data[i].median_earnings_graduate_or_professional_degree);earnings.push(graduateDegreeEarnings),this.drawSteppedAreaChart("earnings-chart",earnings,{areaOpacity:0,connectSteps:!0,curveType:"function",focusTarget:"category",legend:{position:"bottom"},title:"Earnings by Education Level",vAxis:{format:"currency"}})}},{key:"drawEarningsMap",value:function(){var _this6=this,controller=new ApiController,placesPromise=controller.getPlaces(),earningsPromise=controller.getEarningsByPlace();Promise.all([placesPromise,earningsPromise]).then(function(values){var placesResponse=values[0],earningsResponse=values[1],regionPlaces=_this6.getPlacesForRegion(placesResponse),placeMap={};placesResponse.forEach(function(place){return placeMap[place.id]=place});var earningsPlaces=[];earningsResponse.forEach(function(item){0!=item.median_earnings&&item.id in placeMap&&earningsPlaces.push({coordinates:placeMap[item.id].location.coordinates,id:item.id,name:item.name,value:parseInt(item.median_earnings)})}),earningsPlaces.sort(function(a,b){return b.value-a.value});var earnings=_.map(earningsPlaces,function(x){return x.value}),radiusScale=_this6.getRadiusScaleLinear(earnings),colorScale=_this6.getColorScale(earnings),coordinates=regionPlaces[0].location.coordinates,center=[coordinates[1],coordinates[0]],map=L.map("map",{zoomControl:!0});L.tileLayer("https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png").addTo(map),map.setView(center,_this6.MAP_INITIAL_ZOOM),_this6.drawCirclesForPlaces(map,earningsPlaces,radiusScale,colorScale),_this6.drawMarkersForPlaces(map,regionPlaces)})["catch"](function(error){return console.error(error)})}},{key:"drawEarningsTable",value:function(regionIds,data){for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td>Median Earnings (All Workers)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Female Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].female_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr><tr><td>Median Male Earnings (Full Time)</td>";for(var i=0;i<regionIds.length;i++)s+="<td>"+numeral(data[i].male_full_time_median_earnings).format("$0,0")+"</td>";s+="</tr>",$("#earnings-table").html(s)}},{key:"drawHealthData",value:function(){var _this7=this;google.setOnLoadCallback(function(){var regionIds=_this7.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getHealthRwjfChrData(regionIds).then(function(data){return _this7.drawRwjfChrTable(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawRwjfChrTableRow",value:function(regionIds,data,first_td,var_label,var_key,fmt_str){for(var addl_fmt=arguments.length<=6||void 0===arguments[6]?"":arguments[6],s="<tr>"+first_td+"<td class='align-left'>"+var_label+"</td>",i=0;i<regionIds.length;i++)s+="<td>",
s+=data[i]&&data[i][var_key]?numeral(data[i][var_key].replace(",","")).format(fmt_str)+addl_fmt:"",s+="</td>";return s+="</tr>"}},{key:"drawRwjfChrTable",value:function(regionIds,data){var s="";s+="<tr><th></th><th></th>";for(var i=0;i<regionIds.length;i++)s+="<th>"+this.params.regions[i].name+"</th>";s+="</tr>",s+="<tr><td colspan="+numeral(regionIds.length)+"1>HEALTH OUTCOMES</td></tr>",s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=1>Length of Life</td>","Premature Death","premature_death_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=4>Quality of Life</td>","Poor or fair health","poor_or_fair_health_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Poor physical health days","poor_physical_health_days_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Poor mental health days","poor_mental_health_days_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Low birthweight","low_birthweight_value","0.0%"),s+="<tr><td colspan="+numeral(regionIds.length)+"1>HEALTH FACTORS</td></tr>",s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=9>Health Behaviors</td>","Adult smoking","adult_smoking_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Adult obesity","adult_obesity_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Food environment index","food_environment_index_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Physical inactivity","physical_inactivity_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Access to exercise opportunities","access_to_exercise_opportunities_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Excessive drinking","excessive_drinking_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Alcohol-impaired driving deaths","alcohol_impaired_driving_deaths_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Sexually transmitted infections","sexually_transmitted_infections_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Teen births","alcohol_impaired_driving_deaths_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=7>Clinical Care</td>","Uninsured","uninsured_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Primary care physicians","primary_care_physicians_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Dentists","dentists_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Mental health providers","mental_health_providers_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Preventable hospital stays","preventable_hospital_stays_value","0,0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Diabetic monitoring","diabetic_screening_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Mammography screening","mammography_screening_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=9>Social & Economic Factors</td>","High school graduation","high_school_graduation_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Some college","some_college_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Unemployment","unemployment_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Children in poverty","children_in_poverty_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Income inequality","income_inequality_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Children in single-parent households","children_in_single_parent_households_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Social associations","social_associations_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Violent crime","violent_crime_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Injury deaths","injury_deaths_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"<td rowspan=5>Physical Environment</td>","Air pollution - particulate matter","air_pollution_particulate_matter_value","0.0"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Drinking water violations","drinking_water_violations_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Severe housing problems","severe_housing_problems_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Driving alone to work","driving_alone_to_work_value","0.0%"),s+=this.drawRwjfChrTableRow(regionIds,data,"","Long commute - driving alone","long_commute_driving_alone_value","0.0%"),$("#rwjf-county-health-rankings-table").html(s)}},{key:"drawEducationData",value:function(){var _this8=this;google.setOnLoadCallback(function(){var regionIds=_this8.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getEducationData(regionIds).then(function(data){_this8.drawEducationMap(),_this8.drawEducationTable(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawEducationMap",value:function(){var _this9=this,controller=new ApiController,placesPromise=controller.getPlaces(),educationPromise=controller.getEducationByPlace();return Promise.all([placesPromise,educationPromise]).then(function(values){var placesResponse=values[0],educationResponse=values[1],regionPlaces=_this9.getPlacesForRegion(placesResponse),placeMap={};placesResponse.forEach(function(place){return placeMap[place.id]=place});var educationPlaces=[];educationResponse.forEach(function(item){0!=item.percent_bachelors_degree_or_higher&&item.id in placeMap&&educationPlaces.push({coordinates:placeMap[item.id].location.coordinates,id:item.id,name:item.name,value:parseInt(item.percent_bachelors_degree_or_higher)})}),educationPlaces.sort(function(a,b){return b.value-a.value});var earnings=_.map(educationPlaces,function(x){return x.value}),radiusScale=_this9.getRadiusScaleLinear(earnings),colorScale=_this9.getColorScale(earnings),coordinates=regionPlaces[0].location.coordinates,center=[coordinates[1],coordinates[0]],map=L.map("map",{zoomControl:!0});L.tileLayer("https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png").addTo(map),map.setView(center,_this9.MAP_INITIAL_ZOOM),_this9.drawCirclesForPlaces(map,educationPlaces,radiusScale,colorScale),_this9.drawMarkersForPlaces(map,regionPlaces)})["catch"](function(error){return console.error(error)})}},{key:"drawEducationTable",value:function(regionIds,data){for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Percent</td><td class='column-header'>Percentile</td>";s+="</tr><tr><td>At Least Bachelor's Degree</td>";for(var i=0;i<regionIds.length;i++){var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_bachelors_degree_or_higher_rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+data[i].percent_bachelors_degree_or_higher+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr><tr><td>At Least High School Diploma</td>";for(var i=0;i<regionIds.length;i++){var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_high_school_graduate_or_higher),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+data[i].percent_high_school_graduate_or_higher+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr>",$("#education-table").html(s)}},{key:"drawGdpData",value:function(){var _this10=this;google.setOnLoadCallback(function(){var regionIds=_this10.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getGdpData(regionIds).then(function(data){_this10.drawGdpChart(regionIds,data),_this10.drawGdpChangeChart(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawGdpChart",value:function(regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].per_capita_gdp));for(var key in o)chartData.push(o[key]);this.drawLineChart("per-capita-gdp-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Per Capita Real GDP over Time"})}},{key:"drawGdpChangeChart",value:function(regionIds,data){for(var chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var o={},i=0;i<data.length;i++)void 0==o[data[i].year]&&(o[data[i].year]=[data[i].year]),o[data[i].year].push(parseFloat(data[i].per_capita_gdp_percent_change)/100);for(var key in o)chartData.push(o[key]);this.drawLineChart("per-capita-gdp-change-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Annual Change in Per Capita GDP over Time",vAxis:{format:"#.#%"}})}},{key:"drawOccupationsData",value:function(){var _this11=this;google.setOnLoadCallback(function(){var regionIds=_this11.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getOccupationsData(regionIds).then(function(data){_this11.drawOccupationsMap(),_this11.drawOccupationsTable(regionIds,data)})["catch"](function(error){return console.error(error)})})}},{key:"drawOccupationsMap",value:function(){var _this12=this,controller=new ApiController,placesPromise=controller.getPlaces(),occupationsPromise=controller.getOccupationsByPlace("Management");Promise.all([placesPromise,occupationsPromise]).then(function(values){var placesResponse=values[0],occupationsResponse=values[1],regionPlaces=_this12.getPlacesForRegion(placesResponse),placeMap={};placesResponse.forEach(function(place){return placeMap[place.id]=place});var occupationsPlaces=[];occupationsResponse.forEach(function(item){0!=item.percent_employed&&item.id in placeMap&&occupationsPlaces.push({coordinates:placeMap[item.id].location.coordinates,id:item.id,name:item.name,value:parseInt(item.percent_employed)})}),occupationsPlaces.sort(function(a,b){return b.value-a.value});var earnings=_.map(occupationsPlaces,function(x){return x.value}),radiusScale=_this12.getRadiusScaleLinear(earnings),colorScale=_this12.getColorScale(earnings),coordinates=regionPlaces[0].location.coordinates,center=[coordinates[1],coordinates[0]],map=L.map("map",{zoomControl:!0});L.tileLayer("https://a.tiles.mapbox.com/v3/socrata-apps.ibp0l899/{z}/{x}/{y}.png").addTo(map),map.setView(center,_this12.MAP_INITIAL_ZOOM),_this12.drawCirclesForPlaces(map,occupationsPlaces,radiusScale,colorScale),_this12.drawMarkersForPlaces(map,regionPlaces)})["catch"](function(error){return console.error(error)})}},{key:"drawOccupationsTable",value:function(regionIds,data){for(var s="<tr><th></th>",i=0;i<regionIds.length;i++)s+="<th colspan='2'>"+this.params.regions[i].name+"</th>";s+="</tr><tr><td class='column-header'></td>";for(var i=0;i<regionIds.length;i++)s+="<td class='column-header'>Percent</td><td class='column-header'>Percentile</td>";for(var i=0;i<data.length;i++){i%regionIds.length==0&&(s+="</tr><tr><td>"+data[i].occupation+"</td>");var totalRanks=parseInt(data[i].total_ranks),rank=parseInt(data[i].percent_employed_rank),percentile=parseInt((totalRanks-rank)/totalRanks*100);s+="<td>"+numeral(data[i].percent_employed).format("0.0")+"%</td>",s+="<td>"+numeral(percentile).format("0o")+"</td>"}s+="</tr>",$("#occupations-table").html(s)}},{key:"drawPopulationData",value:function(){var _this13=this;google.setOnLoadCallback(function(){var regionIds=_this13.params.regions.map(function(region){return region.id}),controller=new ApiController;controller.getPopulationData(regionIds).then(function(data){_this13.drawPopulationMap(),_this13.drawPopulationChart(regionIds,data),_this13.drawPopulationChangeChart(regionIds,data)})["catch"](function(error){throw error})})}},{key:"drawPopulationChart",value:function(regionIds,data){for(var year,chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,chartData.push(year)),year[m+1]=parseInt(data[i].population)}this.drawLineChart("population-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population"})}},{key:"drawPopulationChangeChart",value:function(regionIds,data){for(var year,chartData=[],header=["Year"],i=0;i<regionIds.length;i++)header[i+1]=this.params.regions[i].name;chartData.push(header);for(var i=0;i<data.length;i++){var m=i%regionIds.length;0==m&&(year=[],year[0]=data[i].year,chartData.push(year)),year[m+1]=parseFloat(data[i].population_percent_change)/100}this.drawLineChart("population-change-chart",chartData,{curveType:"function",legend:{position:"bottom"},pointShape:"square",pointSize:8,title:"Population Change",vAxis:{format:"#.#%"}})}},{key:"drawPopulationMap",value:function(){var testSource={name:"population",domain:"odn.data.socrata.com",fxf:"e3rd-zzmr"},testRegion=MapConstants.REGIONS.state,testVariable={name:"Population (2013)",column:"population",params:{year:2013},value:parseFloat,format:d3.format(",.0f"),reverse:!0};TopoModel.get(testRegion).then(function(topology){var view=new MapContainer("#map",topology);MapModel.create(testSource,testRegion,testVariable).then(function(model){view.display(model)},function(error){throw error})},function(error){throw error})}},{key:"drawPlacesInRegion",value:function(){if(0!=this.params.regions.length){var region=this.params.regions[0];switch(region.type){case"nation":this.drawChildPlacesInRegion(region,"Regions in {0}".format(region.name));break;case"region":this.drawChildPlacesInRegion(region,"Divisions in {0}".format(region.name));break;case"division":this.drawChildPlacesInRegion(region,"States in {0}".format(region.name));break;case"state":this.drawCitiesAndCountiesInState(region);break;case"county":this.drawOtherCountiesInState(region);break;case"msa":this.drawOtherMetrosInState(region);break;case"place":this.drawOtherCitiesInState(region)}}}},{key:"drawChildPlacesInRegion",value:function(region,label){var _this14=this,controller=new ApiController;controller.getChildRegions(region.id).then(function(response){_this14.drawPlacesInRegionHeader("#places-in-region-header-0",label),_this14.drawPlacesInRegionList("#places-in-region-list-0",response)})["catch"](function(error){return console.error(error)})}},{key:"drawCitiesAndCountiesInState",value:function(region){var _this15=this,controller=new ApiController,citiesPromise=controller.getCitiesInState(region.id),countiesPromise=controller.getCountiesInState(region.id);return Promise.all([citiesPromise,countiesPromise]).then(function(values){0!=values.length&&(values[0].length>0&&(_this15.drawPlacesInRegionHeader("#places-in-region-header-0","Places in {0}".format(region.name)),_this15.drawPlacesInRegionList("#places-in-region-list-0",values[0])),values[1].length>0&&(_this15.drawPlacesInRegionHeader("#places-in-region-header-1","Counties in {0}".format(region.name)),_this15.drawPlacesInRegionList("#places-in-region-list-1",values[1])))})["catch"](function(error){return console.error(error)})}},{key:"drawOtherCitiesInState",value:function(region){var _this16=this,controller=new ApiController;controller.getParentState(region).then(function(response){if(0!=response.length){var state=response[0];controller.getCitiesInState(state.parent_id).then(function(response){0!=response.length&&(_this16.drawPlacesInRegionHeader("#places-in-region-header-0","Places in {0}".format(state.parent_name)),_this16.drawPlacesInRegionList("#places-in-region-list-0",response))})["catch"](function(error){return console.error(error)})}})}},{key:"drawOtherCountiesInState",value:function(region){var _this17=this,controller=new ApiController;controller.getParentState(region).then(function(response){if(0!=response.length){var state=response[0];controller.getCountiesInState(state.parent_id).then(function(response){0!=response.length&&(_this17.drawPlacesInRegionHeader("#places-in-region-header-0","Counties in {0}".format(state.parent_name)),_this17.drawPlacesInRegionList("#places-in-region-list-0",response))})["catch"](function(error){return console.error(error)})}})}},{key:"drawOtherMetrosInState",value:function(region){var _this18=this,controller=new ApiController;controller.getParentState(region).then(function(response){if(0!=response.length){var state=response[0];controller.getMetrosInState(state.parent_id).then(function(response){0!=response.length&&(_this18.drawPlacesInRegionHeader("#places-in-region-header-0","Metropolitan Areas in {0}".format(state.parent_name)),_this18.drawPlacesInRegionList("#places-in-region-list-0",response))})["catch"](function(error){return console.error(error)})}})}},{key:"removeCurrentRegions",value:function(regions){for(var maxCount=arguments.length<=1||void 0===arguments[1]?5:arguments[1],count=0,rg=[],i=0;i<regions.length;i++)if(!this.isRegionIdContainedInCurrentRegions(regions[i].child_id)){if(rg.push(regions[i]),count==maxCount-1)break;count++}return rg}},{key:"drawPlacesInRegionHeader",value:function(headerId,label){$(headerId).text(label).slideToggle(100)}},{key:"drawPlacesInRegionList",value:function(listId,data){var maxCount=arguments.length<=2||void 0===arguments[2]?5:arguments[2];if(0!=data.length){for(var count=0,s="",i=0;i<data.length;i++)if(!this.isRegionIdContainedInCurrentRegions(data[i].child_id)){if(s+='<li><a href="',s+=this.getSearchPageForRegionsAndVectorUrl(data[i].child_name)+'">',s+=data[i].child_name,s+="</a></li>",count==maxCount-1)break;count++}$(listId).html(s),$(listId).slideToggle(100)}}},{key:"isRegionIdContainedInCurrentRegions",value:function(regionId){for(var j=0;j<this.params.regions.length;j++)if(regionId==this.params.regions[j].id)return!0;return!1}},{key:"drawSimilarRegions",value:function(onClickRegion){var _this19=this;if(0!=this.params.regions.length){var region=this.params.regions[0],controller=new ApiController;controller.getSimilarRegions(region.id).then(function(data){return _this19.drawSimilarRegionsList(data,onClickRegion)})["catch"](function(error){return console.error(error)})}}},{key:"drawSimilarRegionsList",value:function(data,onClickRegion){if(void 0!=data.most_similar){for(var count=0,s="",i=0;i<data.most_similar.length;i++)if(!this.isRegionIdContainedInCurrentRegions(data.most_similar[i].id)){if(s+='<li><a><i class="fa fa-plus"></i>'+data.most_similar[i].name+"</a></li>",4==count)break;count++}$("#similar-regions").html(s),$("#similar-regions").slideToggle(100),$("#similar-regions li a").click(function(){var index=$(this).parent().index();onClickRegion(data.most_similar[index].name)})}}},{key:"drawLineChart",value:function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.LineChart(document.getElementById(chartId));chart.draw(dataTable,options)}},{key:"drawSteppedAreaChart",value:function(chartId,data,options){var dataTable=google.visualization.arrayToDataTable(data),chart=new google.visualization.SteppedAreaChart(document.getElementById(chartId));chart.draw(dataTable,options)}},{key:"getRadiusScaleLinear",value:function(values){return d3.scale.linear().domain(d3.extent(values)).range(this.MAP_RADIUS_SCALE)}},{key:"getRadiusScaleLog",value:function(values){return d3.scale.log().domain(d3.extent(values)).range(this.MAP_RADIUS_SCALE)}},{key:"getColorScale",value:function(values){var _this20=this,domain=function(){function quantile(value,index,list){return d3.quantile(values,(index+1)*step)}var step=1/_this20.MAP_COLOR_SCALE.length;return _.map(_this20.MAP_COLOR_SCALE.slice(1),quantile)}();return d3.scale.quantile().domain(domain).range(this.MAP_COLOR_SCALE)}},{key:"drawCirclesForPlaces",value:function(map,places,radiusScale,colorScale){places.forEach(function(place){var feature={type:"Feature",properties:{name:place.name},geometry:{coordinates:place.coordinates,type:"Point"}},options={fillColor:colorScale(place.value),fillOpacity:1,opacity:0,radius:8,stroke:!1,weight:0};L.geoJson(feature,{pointToLayer:function(feature,latlng){return L.circle(latlng,radiusScale(place.value),options)}}).addTo(map)})}},{key:"drawMarkersForPlaces",value:function(map,places){places.forEach(function(place){var feature={type:"Feature",properties:{name:place.name},geometry:{coordinates:place.location.coordinates,type:"Point"}};L.geoJson(feature).addTo(map)})}},{key:"getPlacesForRegion",value:function(data){var _this21=this,places=[];return data.forEach(function(place){_this21.params.regions.forEach(function(region){place.id==region.id&&places.push(place)})}),places}},{key:"fetchNextPage",value:function(){if(!this.fetching&&!this.fetchedAll){this.fetching=!0,this.incrementPage();var self=this;$.ajax(this.getSearchResultsUrl()).done(function(data,textStatus,jqXHR){return 204==jqXHR.status?(self.decrementPage(),self.fetching=!1,void(self.fetchedAll=!0)):($(".datasets").append(data),void(self.fetching=!1))})}}},{key:"getSearchPageForRegionsAndVectorUrl",value:function(regions,vector,searchResults,queryString){var url="/";if("string"==typeof regions)url+=regions.replace(/,/g,"").replace(/ /g,"_");else if(Array.isArray(regions)){var regionNames=[];regionNames=regions.map(function(region){return region.replace(/,/g,"").replace(/ /g,"_")}),url+=regionNames.join("_vs_")}else url+="search";return vector&&(url+="/"+vector),searchResults&&(url+="/search-results"),queryString&&(url+=queryString),url}},{key:"getSearchPageUrl",value:function(searchResults){if(this.params.regions.length>0||this.params.autoSuggestedRegion){var regionNames=[];return 0==this.params.resetRegions&&(regionNames=this.params.regions.map(function(region){return region.name})),this.params.autoSuggestedRegion&&regionNames.push(this.params.autoSuggestedRegion),this.getSearchPageForRegionsAndVectorUrl(regionNames,this.params.vector,searchResults,this.getSearchQueryString())}return this.getSearchPageForRegionsAndVectorUrl(null,this.params.vector,searchResults,this.getSearchQueryString())}},{key:"getSearchResultsUrl",value:function(){return this.getSearchPageUrl(!0)}},{key:"getSearchQueryString",value:function(){var url="?q="+encodeURIComponent(this.params.q);return this.params.page>1&&(url+="&page="+this.params.page),this.params.categories.length>0&&(url+="&categories="+encodeURIComponent(this.params.categories.join(","))),this.params.domains.length>0&&(url+="&domains="+encodeURIComponent(this.params.domains.join(","))),this.params.standards.length>0&&(url+="&standards="+encodeURIComponent(this.params.standards.join(","))),this.params.debug&&(url+="&debug="),url}},{key:"incrementPage",value:function(){this.params.page++}},{key:"navigate",value:function(){window.location.href=this.getSearchPageUrl()}},{key:"removeRegion",value:function(regionIndex){this.params.regions.splice(regionIndex,1),this.params.page=1}},{key:"setAutoSuggestedRegion",value:function(region,resetRegions){this.params.autoSuggestedRegion=region,this.params.resetRegions=resetRegions,this.params.page=1}},{key:"toggleCategory",value:function(category){var i=this.params.categories.indexOf(category);i>-1?this.params.categories.splice(i,1):this.params.categories.push(category)}},{key:"toggleDomain",value:function(domain){var i=this.params.domains.indexOf(domain);i>-1?this.params.domains.splice(i,1):this.params.domains.push(domain)}},{key:"toggleStandard",value:function(standard){var i=this.params.standards.indexOf(standard);i>-1?this.params.standards.splice(i,1):this.params.standards.push(standard)}}]),SearchPageController}();$(document).ready(function(){var searchPageController=new SearchPageController(_params);if(multiComplete("#q",".region-list").listen(),_params.regions.length>0)switch(_params.vector){case"population":searchPageController.drawPopulationData();break;case"earnings":searchPageController.drawEarningsData();break;case"health":searchPageController.drawHealthData();break;case"education":searchPageController.drawEducationData();break;case"occupations":searchPageController.drawOccupationsData();break;case"cost_of_living":searchPageController.drawCostOfLivingData();break;case"gdp":searchPageController.drawGdpData();break;default:searchPageController.drawPopulationData()}});
//# sourceMappingURL=search.min.js.map