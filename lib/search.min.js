"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function delay(e){return new Promise(function(t,n){setTimeout(t,e)})}function multiComplete(e,t){function n(e){window.location.href=e}var a="odn.data.socrata.com",r=[{name:"Datasets",image:"fa-bar-chart",domain:a,fxf:"fpum-bjbr",column:"encoded",encoded:["domain","fxf"],select:function(e){return n("/dataset/"+e.domain+"/"+e.fxf)},show:function(e,t){e.append("span").attr("class","name").text(t.text).append("span").attr("id","tag").text(t.domain)}},{name:"Regions",image:"fa-globe",domain:a,fxf:"68ht-6puw",column:"all",encoded:["id","type","population"],select:function(e){n("/region/"+e.id+"/"+e.text.replace(/ /g,"_").replace(/\//g,"_").replace(/,/g,""))},sort:function(e){return-parseFloat(e.population)}},{name:"Publishers",image:"fa-newspaper-o",domain:a,fxf:"8ae5-ghum",column:"domain",select:function(e){return n("/search?domains="+e.text)}},{name:"Categories",image:"fa-fighter-jet",domain:a,fxf:"864v-r7tf",column:"category",select:function(e){return n("/search?categories="+e.text)},show:function(e,t){e.append("span").attr("class","capitalize").text(t.text)}}],o=new Autosuggest(t,r);return o.listen(e),o}function regionsWithData(e,t){var n=_nameToColumn.has(e)?_nameToColumn.get(e):defaultColumn;return[_.extend({},_withDataSource,{select:t,column:n})]}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function variableGenerator(){var e=arguments.length<=0||void 0===arguments[0]?[2013]:arguments[0],t=arguments.length<=1||void 0===arguments[1]?parseFloat:arguments[1];return function(n){return n.map(function(n){var a=_slicedToArray(n,5),r=a[0],o=a[1],i=a[2],s=a[3],l=a[4];return{name:r,column:o,format:i,years:e,value:t,stoplight:s,metric:l}})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPercent(e){return function(t){return t.map(function(t){return _.extend(t,_defineProperty({},e,parseFloat(t[e])/100))})}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}$(document).ready(function(){$(".search-link").click(function(){var e=$("#q").val().trim();0===e.length?$("#q").focus():$("#form").submit()})}),Array.prototype.includes=function(e){return this.indexOf(e)>-1},String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,n){return"undefined"!=typeof e[n]?e[n]:t})},String.prototype.split2=function(e){var t=this.split(e);return 1==t.length&&""===t[0]?[]:t};var Constants={ROSTER_URL:"https://federal.demo.socrata.com/resource/bdeb-mf9k.json",AUTOCOMPLETE_SEPARATOR:":",AUTOCOMPLETE_URL:function(e,t,n,a){return"https://"+e+"/views/"+t+"/columns/"+n+"/suggest/"+a},AUTOCOMPLETE_WAIT_MS:150,AUTOCOMPLETE_MAX_OPTIONS:100,AUTOCOMPLETE_SHOWN_OPTIONS:5,PEER_REGIONS:5,PEER_REGIONS_MAX:10,DEFAULT_CHART_OPTIONS:{curveType:"function",lineWidth:4,legend:{position:"top"},pointShape:"circle",pointSize:6,height:300,colors:["#2ecc71","#3498db","#9b59b6","#f1c40f","#e67e22","#e74c3c","#34495e","#1abc9c"]}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),RegionLookup=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"get",value:function(e){return $.getJSON(Constants.ROSTER_URL+"?"+$.param(e))}},{key:"getOne",value:function(t){function n(e){if(0===e.length)return console.warn("no regions found for params: "),console.warn(t),null;if(1===e.length)return e[0];var n=_.filter(e,function(e){return"place"===e.type});return n.length>0?n[0]:e[0]}return new Promise(function(a,r){e.get(t).then(function(e){a(n(e))},function(e){throw e})})}},{key:"byName",value:function(t){return e.getOne({name:t})}},{key:"byID",value:function(t){return e.getOne({id:t})}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Sources=function(){function e(t){_classCallCheck(this,e),this.sources=t}return _createClass(e,[{key:"forRegions",value:function(t){var n=new Set(t.map(function(e){return e.type}));return this.sources.filter(function(t){var a=new Set(t.regions);return e.intersection(a,n).size>0})}}],[{key:"intersection",value:function(e,t){return new Set([].concat(_toConsumableArray(e)).filter(function(e){return t.has(e)}))}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Base64=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"encode",value:function(e){return btoa(unescape(encodeURIComponent(str)))}},{key:"decode",value:function(e){return decodeURIComponent(escape(atob(e)))}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),AutosuggestSource=function(){function e(t,n,a,r,o,i,s,l,u){_classCallCheck(this,e),this.name=t,this.image=n,this.domain=a,this.fxf=r,this.column=o,this.encoded=i,this.select=s,this.show=l,this.sort=u}return _createClass(e,[{key:"get",value:function(e){var t=this;return new Promise(function(n,a){if(""===e)n([]);else{var r=Constants.AUTOCOMPLETE_URL(t.domain,t.fxf,t.column,e),o=t.sort?Constants.AUTOCOMPLETE_MAX_OPTIONS:Constants.AUTOCOMPLETE_SHOWN_OPTIONS,i={size:o},s=r+"?"+$.param(i);$.getJSON(s).then(function(e){n(e.options.map(function(e){return t.decode(e)}))},a)}})}},{key:"decode",value:function(e){if(this.encoded.length>0){var t=e.text,n=t.lastIndexOf(" "),a=t.substring(0,n),r=t.substring(n+1),o=Base64.decode(r),i=o.split(Constants.AUTOCOMPLETE_SEPARATOR);return _.extend({text:a},_.object(this.encoded,i))}return{text:e.text}}},{key:"display",value:function(e,t){var n=this;if(0===t.length)return[];this.sort&&(t=_.sortBy(t,this.sort).slice(0,Constants.AUTOCOMPLETE_SHOWN_OPTIONS));var a=e.append("li").attr("class","autocomplete-category");if(this.image){a.append("label").attr("class","autocomplete-title").text(this.name);if(t.length>1){a.append("div").append("i").attr("class","fa "+this.image)}}var r=a.append("ul").attr("class","autocomplete-options sub-list"),o=this;return r.selectAll("li").data(t).enter().append("li").attr("class","autocomplete-option").each(function(e){o.show(d3.select(this),e)}).on("click",function(e){return n.select(e)}).on("mouseover.source",function(){d3.select(this).classed("selected hovered",!0)}).on("mouseout.source",function(){d3.select(this).classed("selected hovered",!1)})[0]}}],[{key:"fromJSON",value:function(t){var n=t.encoded||[],a=t.show||function(e,t){e.append("span").text(t.text)};return new e(t.name,t.image,t.domain,t.fxf,t.column,n,t.select,a,t.sort)}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),AutosuggestResults=function(){function e(t){_classCallCheck(this,e),this.results=d3.select(t),this.options=[],this.index=-1,this.autohide()}return _createClass(e,[{key:"autohide",value:function(){var e=this;d3.select("html").on("click.results",function(){return e.hide()}),this.results.on("click.results",function(){return d3.event.stopPropagation()})}},{key:"hide",value:function(){this.results.style("display","none")}},{key:"unhide",value:function(){this.results.style("display","block")}},{key:"empty",value:function(){this.results.html("")}},{key:"display",value:function(e){var t=this;return new Promise(function(n,a){t.source.get(e).then(function(e){t.empty(),0===e.length?(t.hide(),n([])):(t.unhide(),n(t.source.display(t.results,e)))},function(e){throw e})})}},{key:"show",value:function(e,t){var n=this;this.empty();var a=e.map(function(e,a){var r=t[a];return e.display(n.results,r)});this.updateOptions(_.flatten(a)),this.unhide()}},{key:"updateOptions",value:function(e){var t=this;this.options=e.map(function(e){return d3.select(e)}),this.options.forEach(function(e,n){e.on("mouseover.results",function(){t.index=n,t.updateSelected()}).on("mouseout.results",function(){t.index=-1,t.updateSelected()})})}},{key:"updateSelected",value:function(){var e=this;this.options.forEach(function(t,n){t.classed("selected",n===e.index)})}},{key:"keydown",value:function(e){38==e?this.up():40==e&&this.down(),this.updateSelected()}},{key:"up",value:function(){this.index>0?this.index-=1:this.index=this.options.length-1}},{key:"down",value:function(){this.index<this.options.length-1?this.index+=1:this.index=0}},{key:"enter",value:function(){var e=this.options[this.index];e.on("click")(e.datum())}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Autosuggest=function(){function e(t,n){_classCallCheck(this,e),this.sources=n.map(AutosuggestSource.fromJSON),this.results=new AutosuggestResults(t),this._currentTerm="",this._time=Date.now()}return _createClass(e,[{key:"listen",value:function(e){var t=this;d3.select(e).on("keydown",function(){var e=d3.event.keyCode;13==e?(d3.event.preventDefault(),t.enter()):t.results.keydown(e)}).on("input",function(){t.throttledSuggest(this.value)})}},{key:"throttledSuggest",value:function(e){var t=this;delay(Constants.AUTOCOMPLETE_WAIT_MS).then(function(){e===t._currentTerm&&t.suggest(e)}),this._currentTerm=e}},{key:"suggest",value:function(e){var t=this;""===e?this.results.hide():!function(){var n=Date.now(),a=t.sources.map(function(t){return t.get(e)});Promise.all(a).then(function(e){n>t._time&&(t._time=n,t.results.show(t.sources,e))})}()}},{key:"enter",value:function(){if(this.results.index<0){var e="/search?"+$.param({q:this._currentTerm});window.location.href=e}else this.results.enter()}}]),e}(),domain="odn.data.socrata.com",_nameToColumn=new Map;_nameToColumn.set("population","population"),_nameToColumn.set("earnings","earnings"),_nameToColumn.set("education","education"),_nameToColumn.set("occupations","occupations"),_nameToColumn.set("cost_of_living","rpp"),_nameToColumn.set("gdp","gdp"),_nameToColumn.set("health","health");var defaultColumn="all",_withDataSource={name:"Regions with Data",domain:domain,fxf:"68ht-6puw",encoded:["id","type","population"],sort:function(e){return-parseFloat(e.population)}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Scale=function(){function e(t,n,a){_classCallCheck(this,e),this.values=t,this.range=n,this.scale=a}return _createClass(e,null,[{key:"quantile",value:function(t,n){t.sort(d3.ascending);var a=1/n.length,r=_.map(n.slice(1),function(e,n){return d3.quantile(t,(n+1)*a)}),o=d3.scale.quantile().domain(r).range(n);return new e(t,n,o)}}]),e}(),MapConstants={LIMIT:5e3,CSS_ID:"leaflet-map",MAPBOX_TOKEN:"pk.eyJ1IjoibGFuZWFhc2VuIiwiYSI6ImYxZjExYmYzOTMxYzgyZTc2NDY0NDBmNDNmZmEwYWM3In0.uy5ta6EsSEZggkVQHo2ygw",LABEL_LAYER_ID:"socrata-apps.cb421623",BASE_LAYER_ID:"socrata-apps.af2cc4ed",COLOR_SCALE:colorbrewer.Blues[9].slice(2),STOPLIGHT_COLOR_SCALE:colorbrewer.RdYlGn[7],SCALE:Scale.quantile,MAP_OPTIONS:{minZoom:3,maxZoom:12,zoomControl:!1,attributionControl:!1,scrollWheelZoom:!1},ZOOM_CONTROL:!0,ZOOM_CONTROL_OPTIONS:{position:"topleft"},INITIAL_CENTER:[37.1669,-95.9669],INITIAL_ZOOM:4,AUTO_ZOOM_OPTIONS:{animate:!1,maxZoom:10,paddingTopLeft:[50,0]},AUTO_ZOOM_OUT:1,POINT_RADIUS_SCALE:d3.scale.log,POINT_RADIUS_RANGE_METERS:[500,2e3],BASE_STYLE:{stroke:!0,color:"#2c3e50",opacity:1,weight:2,fill:!1},REFERENCE_STYLE:{fill:!0,fillOpacity:.35,stroke:!0,weight:1,opacity:1},SELECTED_STYLE:{weight:6,dashArray:"4, 8",lineCap:"round"},NO_DATA_STYLE:{fill:!1,stroke:!1},LEGEND_OPACITY:.5,TOOLTIP_OPTIONS:{offset:L.point(0,-20),closeButton:!1,closeOnClick:!1},TOOLTIP_PADDING:16,POPUP_OPTIONS:{closeButton:!1,closeOnClick:!1},TOPOJSON_DIRECTORY:"/geo/",TOPOJSON_SUFFIX:".topo.json",REGIONS:{nation:{name:"USA",id:"nation",topo:"nation",type:"choropleth"},region:{name:"Regions",id:"region",topo:"region",type:"choropleth"},division:{name:"Divisions",id:"division",topo:"division",type:"choropleth"},state:{name:"States",id:"state",topo:"state",type:"choropleth"},county:{name:"Counties",id:"county",topo:"county",type:"choropleth"},msa:{name:"Metros",id:"msa",topo:"cbsa",type:"choropleth"},place:{name:"Cities",id:"place",topo:"places",type:"point"}},DEFAULT_REGION:"state"},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),TopoModel=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"get",value:function(e){var t=MapConstants.TOPOJSON_DIRECTORY+e.topo+MapConstants.TOPOJSON_SUFFIX;return $.getJSON(t)}}]),e}(),MapModel=function(){function e(t,n,a,r,o){_classCallCheck(this,e),this.source=t,this.region=n,this.variable=a,this.year=r,this.regions=o,this.regionById=e.makeLookup(o,function(e){return e.id})}return _createClass(e,[{key:"values",value:function(){return this.regions.map(function(e){return e.value})}},{key:"scale",value:function(e,t){var n=t.slice(0);return this.variable.reverse&&n.reverse(),e(this.values(),n)}}],[{key:"makeLookup",value:function(e,t){var n=new Map;return _.each(e,function(e){return n.set(t(e),e)}),n}},{key:"create",value:function(t,n,a,r){var o=t.idColumn||"id",i=t.typeColumn||"type",s=t.nameColumn||"name",l=t.yearColumn||"year",u=t.hasPopulation||!1,c=t.populationColumn||"population",f=t.value||parseFloat;return new Promise(function(p,m){function h(o){var i=o.map(function(e){var t=f(e[a.column]);return{id:e.id,type:e.type,name:e.name,value:t,valueName:a.name,valueFormatted:a.format(t),year:r}});p(new e(t,n,a,r,i))}function d(e){throw e}var g=[o,i,s,l],v=g.concat([a.column]),y=_defineProperty({type:n.id,$select:v.join(),$limit:MapConstants.LIMIT},l,r),C=u?{$order:c+" DESC"}:{},b=_.extend({},y,C,a.params),O="https://"+t.domain+"/resource/"+t.fxf+".json?"+$.param(b);$.getJSON(O).then(h,d)})}}]),e}(),_slicedToArray=function(){function e(e,t){var n=[],a=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(l){r=!0,o=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),LegendControl=L.Control.extend({options:{position:"bottomleft"},onAdd:function(e){var t=L.DomUtil.create("div","legend-control");return this.container=d3.select(t),t},update:function(e,t,n){this.container.selectAll("*").remove();var a=10,r=e.range.slice();r.reverse();var o=r.length*a,i=this.container.append("div").attr("class","legend-container"),s=_.filter(e.values,function(e){return!isNaN(e)}),l=d3.extent(s),u=_slicedToArray(l,2),c=u[0],f=u[1],p=d3.quantile(s,.25),m=d3.median(s),h=d3.quantile(s,.75),d=["maximum","upper quartile","median","lower quartile","minimum"],g=[f,h,m,p,c],v=o/(g.length-1),y=2,C="middle",b=i.append("svg").attr("height",o+15).attr("class","legend"),O=b.append("g").attr("class","labels"),w=O.selectAll("text").data(d).enter().append("text").attr("class","tick-label").text(function(e){return e}).attr("text-anchor","end").attr("alignment-baseline",C),T=O.node().getBBox().width+a+y;w.attr("transform",function(e,t){return"translate("+(T-y)+", "+(a+t*v)+")"});var k=b.append("g").attr("class","ticks"),S=k.selectAll("g.tick").data(g).enter().append("g").attr("class","tick").attr("transform",function(e,t){return"translate("+(T+a)+", "+(a+t*v)+")"});S.append("line").attr("class","tick-line").attr("x1",a).attr("y1",0).attr("x2",2*a).attr("y2",0),S.append("line").attr("class","tick-line").attr("x1",-a).attr("y1",0).attr("x2",0).attr("y2",0),S.append("text").attr("class","tick-value").text(function(e){return t.format(e)}).attr("alignment-baseline",C).attr("transform","translate("+(2*a+y)+", 0)");b.selectAll("rect").data(r).enter().append("rect").attr("class","legend-element").attr("x",T+a).attr("y",function(e,t){return(t+1)*a}).attr("width",a).attr("height",a).style("fill",function(e){return e}).style("fill-opacity",MapConstants.LEGEND_OPACITY);b.append("rect").attr("class","legend-box").attr("x",T+a).attr("y",a).attr("width",a).attr("height",o),b.attr("width",b.node().getBBox().width+2*a)}}),_slicedToArray=function(){function e(e,t){var n=[],a=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(l){r=!0,o=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),MapBounds=function(){function e(t){_classCallCheck(this,e),this.$div=t,this.update()}return _createClass(e,[{key:"update",value:function(){var e=this.$div.offset(),t=e.left,n=e.top;this.x1=t,this.y1=n,this.x2=this.x1+this.$div.width(),this.y2=this.y1+this.$div.height(),this.centerX=this.x1+(this.x2-this.x1)/2,this.centerY=this.y1+(this.y2-this.y1)/2}},{key:"normalize",value:function(e){var t=_slicedToArray(e,2),n=t[0],a=t[1];return[n-this.x2,a-this.y2]}},{key:"quadrant",value:function(e){var t=_slicedToArray(e,2),n=t[0],a=t[1];return[n-this.centerX<0,a-this.centerY<0]}}]),e}(),Tooltip=function(){function e(t,n){_classCallCheck(this,e),this.name=t,this.value=n}return _createClass(e,[{key:"show",value:function(){}}],[{key:"fromRegion",value:function(t){var n=t.name,a=t.valueName+" ("+t.year+"): "+t.valueFormatted;return new e(n,a)}}]),e}(),TooltipControl=L.Control.extend({options:{position:"bottomright"},onAdd:function(e){var t=this,n=L.DomUtil.create("div","tooltip");this.container=d3.select(n).style("display","none").attr("id","tooltip"),this.$container=$(this.container[0]),this.name=this.container.append("div").attr("class","name"),this.value=this.container.append("div").attr("class","value"),this.shown=!1;var a=new MapBounds($("#leaflet-map"));return window.onresize=function(){a.update()},document.addEventListener("mousemove",function(e){if(t.shown){var n=[e.pageX,e.pageY],r=a.normalize(n),o=_slicedToArray(r,2),i=o[0],s=o[1],l=a.quadrant(n),u=_slicedToArray(l,2),c=u[0],f=u[1],p=MapConstants.TOOLTIP_PADDING,m=c?i+t.width+p:i-p,h=f?s+t.height+p:s-p;t.container.style("left",m+"px").style("top",h+"px")}}),n},show:function(e,t){this.name.text(e),this.value.text(t),this.width=this.$container.width(),this.height=48,this.unhide()},showRegion:function(e){this.show(e.name,e.valueName+" ("+e.year+"): "+e.valueFormatted)},hide:function(){this.shown=!1,this.container.style("display","none")},unhide:function(){this.shown=!0,this.container.style("display","inline")}}),VariableControl=L.Control.extend({initialize:function(e,t,n){this.variables=e,this.selectedIndices=t,this.callback=n},options:{position:"topleft"},onAdd:function(e){function t(e){var t=e.property("value"),n=e.select("option[value='"+t+"']");return n.datum()}function n(){u.selectAll("option").remove(),_.contains(o.years,i)||(i=o.years[o.years.length-1]),u.selectAll("option").data(o.years).enter().append("option").property("selected",function(e){return e===i}).attr("value",function(e){return e}).text(function(e){return e})}var a=this,r=L.DomUtil.create("div","variable-container");this.container=d3.select(r);var o=this.variables[this.selectedIndices.variableSelectedIndex],i=o.years[this.selectedIndices.yearSelectedIndex],s=function(){a.callback(o,i)};s();var l=this.container.append("select").attr("class","variable-select").on("change",function(){o=t(l),n(),s()}),u=(l.selectAll("option").data(this.variables).enter().append("option").property("selected",function(e){return e===o}).attr("value",function(e){return e.name}).text(function(e){return e.name}),this.container.append("select").attr("class","year-select").on("change",function(){i=t(u),s()}));return n(),r}}),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),MapView=function(){function e(t,n,a,r,o){var i=this;_classCallCheck(this,e),this.source=t,this.regionType=n,this.regions=a,this.regionIDs=new Set(a.map(function(e){return e.id})),this.features=r,this.onDisplay=o,this.legend=new LegendControl,this.tooltip=new TooltipControl,this.variableControl=new VariableControl(t.variables,t.selectedIndices,function(e,t){i.display(e,t),i.onDisplay&&i.onDisplay(e,t)}),this.zoomControl=new L.Control.Zoom(MapConstants.ZOOM_CONTROL_OPTIONS),this._popups=[]}return _createClass(e,[{key:"show",value:function(e){var t=this,n=(d3.select(e).append("div").attr("class","map-container").attr("id",MapConstants.CSS_ID),L.map(MapConstants.CSS_ID,MapConstants.MAP_OPTIONS));this.map=n,n.setView(MapConstants.INITIAL_CENTER,MapConstants.INITIAL_ZOOM),n.addControl(this.legend),n.addControl(this.variableControl),n.addControl(this.tooltip),MapConstants.ZOOM_CONTROL&&n.addControl(this.zoomControl),n.whenReady(function(){var e=function(e){return"https://api.mapbox.com/v4/"+e+"/{z}/{x}/{y}.png?access_token="+MapConstants.MAPBOX_TOKEN},a=(L.tileLayer(e(MapConstants.BASE_LAYER_ID)).addTo(n),t.features.addTo(n),n.createPane("labels"));L.tileLayer(e(MapConstants.LABEL_LAYER_ID),{pane:a}).addTo(n);t.zoomToSelected(n)})}},{key:"zoomToSelected",value:function(e){var t=this,n=[];this.features.eachLayer(function(e){t.regionIDs.has(e.feature.id)&&n.push(e)});var a=new L.featureGroup(n);e.fitBounds(a.getBounds(),MapConstants.AUTO_ZOOM_OPTIONS),"choropleth"===this.regionType.type&&1===n.length&&e.zoomOut(MapConstants.AUTO_ZOOM_OUT,MapConstants.AUTO_ZOOM_OPTIONS)}},{key:"display",value:function(e,t){var n=this;MapModel.create(this.source,this.regionType,e,t).then(function(e){return n.update(e)})["catch"](function(e){throw e})}},{key:"update",value:function(e){var t=e.variable.stoplight?MapConstants.STOPLIGHT_COLOR_SCALE:MapConstants.COLOR_SCALE,n=e.scale(MapConstants.SCALE,t);this.updateLegend(e,n),this.updateFeatures(e,n)}},{key:"updateLegend",value:function(e,t){this.legend.update(t,e.variable,e.year)}},{key:"updateFeatures",value:function(t,n){var a=this;this.features.eachLayer(function(r){var o=t.regionById.get(r.feature.id);if(o&&!isNaN(o.value)){var i=a.regionIDs.has(o.id),s=n.scale(o.value),l=_.extend({},MapConstants.REFERENCE_STYLE,{fillColor:s}),u=i?_.extend(l,MapConstants.SELECTED_STYLE):l;if(r.setStyle(u),i&&a.map){if(!(o.id in a._popups)){var c=L.popup(MapConstants.POPUP_OPTIONS).setLatLng(e.center(r));a._popups[o.id]=c}var f='<div class="name">'+o.name+'</div>                        <div class="value">'+o.valueName+" ("+o.year+"):                        "+o.valueFormatted+"</div>";a._popups[o.id].setContent(f).addTo(a.map)}r.on({mouseover:function(){a.closePopups(),a.tooltip.showRegion(o)},mouseout:function(){return a.tooltip.hide()}})}else r.setStyle(MapConstants.NO_DATA_STYLE)})}},{key:"closePopups",value:function(){var e=this;_.values(this._popups).forEach(function(t){return e.map.closePopup(t)})}}],[{key:"center",value:function(e){if(e.getLatLng)return e.getLatLng();var t=e.getLatLngs(),n=L.latLngBounds(_.flatten(t));return n.getCenter()}},{key:"create",value:function(t,n,a){if(n.length<1)throw"regions cannot be empty";return new Promise(function(r,o){var i=MapConstants.REGIONS[n[0].type];void 0===i?o("invalid region type for map: "+n[0].type):!function(){var s=_.filter(n,function(e){return e.type==i.id});TopoModel.get(i).then(function(n){var o=e._features(n,"choropleth"==i.type);r(new e(t,i,s,o,a))},o)}()})}},{key:"_features",value:function(e,t){var n=function(){var e={stroke:!1},n=t?MapConstants.BASE_STYLE:_.extend({},MapConstants.BASE_STYLE,e);return{style:function(){return n}}},a=function(){var t=e.objects,n=e.objects[Object.keys(t)[0]].geometries,a=function(e){return e.properties.population},r=n.map(a),o=MapConstants.POINT_RADIUS_SCALE().domain(d3.extent(r)).range(MapConstants.POINT_RADIUS_RANGE_METERS);return{pointToLayer:function(e,t){return L.circle(t,o(a(e)))}}},r=t?n():_.extend({},n(),a()),o=L.geoJson(null,r);return omnivore.topojson.parse(e,null,o)}}]),e}(),format={integer:d3.format(",.0f"),percent:function(e){return d3.format(".2f")(e)+"%"},ratio:d3.format(".1%"),dollar:d3.format("$,.0f")},_slicedToArray=function(){function e(e,t){var n=[],a=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(l){r=!0,o=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),DOMAIN="odn.data.socrata.com",MAP_SOURCES={population:{name:"population",domain:DOMAIN,fxf:"e3rd-zzmr",hasPopulation:!0,variables:[{name:"Population",column:"population",years:[2009,2010,2011,2012,2013],format:format.integer,metric:"population_value"},{name:"Population Change",column:"population_percent_change",years:[2010,2011,2012,2013],format:format.percent,stoplight:!0,metric:"population_change"}]},earnings:{name:"earnings",domain:DOMAIN,fxf:"wmwh-4vak",hasPopulation:!0,variables:variableGenerator()([["Median Earnings","median_earnings",format.dollar,!0,"median_earnings"],["Median Female Earnings","female_median_earnings",format.dollar,!0,"female_median_earnings"],["Median Male Earnings","male_median_earnings",format.dollar,!0,"male_median_earnings"],["Median Female Earnings (Full Time)","female_full_time_median_earnings",format.dollar,!0,"female_full_time_median_earnings"],["Median Male Earnings (Full Time)","male_full_time_median_earnings",format.dollar,!0,"male_full_time_median_earnings"],["Percent Earning less than $10,000","percent_with_earnings_1_to_9999",format.percent,!1,"percent_with_earnings_1_to_9999"],["Percent Earning $10,000 to $14,999","percent_with_earnings_10000_to_14999",format.percent,!1,"percent_with_earnings_10000_to_14999"],["Percent Earning $15,000 to $24,999","percent_with_earnings_15000_to_24999",format.percent,!1,"percent_with_earnings_15000_to_24999"],["Percent Earning $25,000 to $34,999","percent_with_earnings_25000_to_34999",format.percent,!1,"percent_with_earnings_25000_to_34999"],["Percent Earning $35,000 to $49,999","percent_with_earnings_35000_to_49999",format.percent,!1,"percent_with_earnings_35000_to_49999"],["Percent Earning $50,000 to $64,999","percent_with_earnings_50000_to_64999",format.percent,!1,"percent_with_earnings_50000_to_64999"],["Percent Earning $65,000 to $74,999","percent_with_earnings_65000_to_74999",format.percent,!1,"percent_with_earnings_65000_to_74999"],["Percent Earning $75,000 to $99,999","percent_with_earnings_75000_to_99999",format.percent,!1,"percent_with_earnings_75000_to_99999"],["Percent Earning over $100,000","percent_with_earnings_over_100000",format.percent,!1,"percent_with_earnings_over_100000"]])},education:{name:"education",domain:DOMAIN,fxf:"uf4m-5u8r",hasPopulation:!0,variables:variableGenerator()([["High School Graduation Rate","percent_high_school_graduate_or_higher",format.percent,!0,"percent_high_school_graduate_or_higher"],["College Graduation Rate","percent_bachelors_degree_or_higher",format.percent,!0,"percent_bachelors_degree_or_higher"]])},occupations:{name:"occupations",domain:DOMAIN,fxf:"qfcm-fw3i",hasPopulation:!0,variables:["Business and Finance","Computers and Math","Construction and Extraction","Education","Engineering","Farming, Fishing, Foresty","Fire Fighting","Food Service","Healthcare","Health Support","Health Technicians","Janitorial","Law Enforcement","Legal","Management","Material Moving","Media","Office and Administration","Personal Care","Production","Repair","Sales","Social Sciences","Social Services","Transportation"].map(function(e){return{name:e,column:"percent_employed",params:{occupation:e},years:[2013],format:format.percent,metric:""+e.toLowerCase().replace(/\s/g,"_").replace(/,/g,"")}})},gdp:{name:"gdp",domain:DOMAIN,fxf:"ks2j-vhr8",variables:[{name:"GDP per Capita",column:"per_capita_gdp",years:_.range(2001,2014),format:format.dollar,stoplight:!0,metric:"per_capita_gdp"},{name:"Annual Change in GDP",column:"per_capita_gdp_percent_change",years:_.range(2002,2014),format:format.percent,stoplight:!0,metric:"per_capita_gdp_change"}]},rpp:{name:"rpp",domain:DOMAIN,fxf:"hpnf-gnfu",variables:["All","Goods","Rents","Other"].map(function(e){return{name:e,column:"index",reverse:!0,params:{component:e},years:_.range(2008,2014),format:d3.format(".1f"),stoplight:!0,metric:e.toLowerCase()}})},health:{name:"health",domain:DOMAIN,fxf:"7ayp-utp2",variables:["Adult Smoking","Adult Obesity","Physical Inactivity","Excessive Drinking"].map(function(e){return{name:e+" Rate",column:e.toLowerCase().replace(/\s/g,"_")+"_value",years:[2015],reverse:!0,format:format.ratio,stoplight:!0,metric:e.toLowerCase().replace(/\s/g,"_")+"_rate"}})}},MapSummaryFormatters={population:{format:"0,0",suffix:""},population_percent_change:{format:"0.00",suffix:"%"},percent_high_school_graduate_or_higher:{format:"0.0",suffix:"%"
},percent_bachelors_degree_or_higher:{format:"0.0",suffix:"%"},median_earnings:{format:"$0,0",suffix:""},female_median_earnings:{format:"$0,0",suffix:""},male_median_earnings:{format:"$0,0",suffix:""},female_full_time_median_earnings:{format:"$0,0",suffix:""},male_full_time_median_earnings:{format:"$0,0",suffix:""},percent_with_earnings_1_to_9999:{format:"0.0",suffix:"%"},percent_with_earnings_10000_to_14999:{format:"0.0",suffix:"%"},percent_with_earnings_15000_to_24999:{format:"0.0",suffix:"%"},percent_with_earnings_25000_to_34999:{format:"0.0",suffix:"%"},percent_with_earnings_35000_to_49999:{format:"0.0",suffix:"%"},percent_with_earnings_50000_to_64999:{format:"0.0",suffix:"%"},percent_with_earnings_65000_to_74999:{format:"0.0",suffix:"%"},percent_with_earnings_75000_to_99999:{format:"0.0",suffix:"%"},percent_with_earnings_over_100000:{format:"0.0",suffix:"%"},percent_employed:{format:"0.0",suffix:"%"},per_capita_gdp:{format:"$0,0",suffix:""},per_capita_gdp_percent_change:{format:"0.0",suffix:"%"},adult_smoking_value:{format:"0.0%",suffix:""},adult_obesity_value:{format:"0.0%",suffix:""},physical_inactivity_value:{format:"0.0%",suffix:""},excessive_drinking_value:{format:"0.0%",suffix:""}},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),MapSummary=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getSummaryString",value:function(e,t,n,a,r){var o=this,i=e.map(function(e,i){var s=_.filter(t[i],r)[0];return"The {0} in {1} for {2} was {3}.".format(n.name.toLowerCase(),a,e.name,o.formatValue(n.column,s[n.column]))});return i.join(" ")}},{key:"getCostOfLivingSummaryString",value:function(e,t,n,a,r){var o=this,i=e.map(function(e,i){var s=_.filter(t[i],r)[0];return"all"==n.name.toLowerCase()?"The cost of living index in {0} for {1} was {2}.".format(a,e.name,o.formatValue(n.column,s[n.column])):"The cost of living index for {0} in {1} for {2} was {3}.".format(n.name.toLowerCase(),a,e.name,o.formatValue(n.column,s[n.column]))});return i.join(" ")}},{key:"getOccupationsSummaryString",value:function(e,t,n,a,r){var o=this,i=e.map(function(e,i){var s=_.filter(t[i],r)[0];return"The percent working in {0} in {1} for {2} was {3}.".format(n.name.toLowerCase(),a,e.name,o.formatValue(n.column,s[n.column]))});return i.join(" ")}},{key:"formatValue",value:function(e,t){if(e in MapSummaryFormatters){var n=MapSummaryFormatters[e];return numeral(t).format(n.format)+n.suffix}return t}}]),e}(),ODN_DOMAIN="odn.data.socrata.com",attributions={acs:{name:"American Community Survey"},bea:{name:"Bureau of Economic Analysis"}},SOURCES={population:{name:"Population",groups:[{name:"Population",attribution:attributions.acs,domain:ODN_DOMAIN,fxf:"e3rd-zzmr",charts:[{name:"Population over Time",data:[{column:"year",label:"Year",type:"string"},{column:"population",label:"Population",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"###,###"}}],chart:google.visualization.LineChart,options:{vAxis:{format:"short"}}},{name:"Population Change over Time",data:[{column:"year",label:"Year",type:"string"},{column:"population_percent_change",label:"Population Change",type:"number",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"#.##%"}}],transform:function(e){return e.filter(function(e){return"2009"!==e.year}).map(function(e){return _.extend(e,{population_percent_change:parseFloat(e.population_percent_change)/100})})},chart:google.visualization.LineChart,options:{vAxis:{format:"#.##%"}}}]}]},education:{name:"Education",description:"Educational data.",groups:[{name:"Education",attribution:attributions.acs,domain:ODN_DOMAIN,fxf:"uf4m-5u8r",charts:[{name:"Graduation Rates",data:[{column:"percent_high_school_graduate_or_higher",label:"High School"},{column:"percent_bachelors_degree_or_higher",label:"College"}],transpose:[{column:"variable",label:"Graduation Rate",type:"string"},{column:"value",label:"Value",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"#.#%"}}],transform:_toPercent("value"),chart:google.visualization.ColumnChart,options:{vAxis:{format:"percent"}}}]}]},earnings:{name:"Earnings",description:"Earnings and income data.",groups:[{name:"Earnings",attribution:attributions.acs,domain:ODN_DOMAIN,fxf:"wmwh-4vak",charts:[{name:"Median Earnings by Gender (Full-Time and Part-Time Workers)",data:[{column:"median_earnings",label:"All"},{column:"male_median_earnings",label:"Male"},{column:"female_median_earnings",label:"Female"}],transpose:[{column:"variable",label:"",type:"string"},{column:"value",label:"Value",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"###,###",prefix:"$"}}],chart:google.visualization.ColumnChart,options:{vAxis:{format:"currency",viewWindow:{min:0}}}},{name:"Median Earnings by Education Level (Full-Time and Part-Time Workers)",data:[{column:"median_earnings_less_than_high_school",label:"Less than High School"},{column:"median_earnings_high_school",label:"High School"},{column:"median_earnings_some_college_or_associates",label:"Some College or Associates"},{column:"median_earnings_bachelor_degree",label:"Bachelor's Degree"},{column:"median_earnings_graduate_or_professional_degree",label:"Graduate or Professional Degree"}],transpose:[{column:"variable",label:"Level of Education",type:"string"},{column:"value",label:"Value",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"###,###",prefix:"$"}}],chart:google.visualization.ColumnChart,options:{vAxis:{format:"currency"}}}]}]},occupations:{name:"Occupations",description:"Occupations data.",groups:[{name:"Percent Employed in Each Occupation",attribution:attributions.acs,domain:ODN_DOMAIN,fxf:"qfcm-fw3i",charts:[{data:[{column:"occupation",label:"Occupation",type:"string"},{column:"percent_employed",label:"Percent Employed",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"#.#%"}}],transform:_toPercent("percent_employed"),chart:google.visualization.Table,options:{height:800}}]}]},gdp:{name:"Gross Domestic Product",description:"Gross Domestic Product (GDP) data.",groups:[{name:"Gross Domestic Product (GDP)",attribution:attributions.bea,domain:ODN_DOMAIN,fxf:"ks2j-vhr8",charts:[{name:"GDP per Capita over Time",data:[{column:"year",label:"Year",type:"string"},{column:"per_capita_gdp",label:"Per Capita GDP",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"$###,###"}}],chart:google.visualization.LineChart,options:{vAxis:{format:"$###,###"}}},{name:"Annual Change in Per Capita GDP",data:[{column:"year",label:"Year",type:"string"},{column:"per_capita_gdp_percent_change",label:"Annual Change in Per Capita GDP over Time",formatter:google.visualization.NumberFormat,formatterOptions:{pattern:"##.#%"}}],transform:_toPercent("per_capita_gdp_percent_change"),chart:google.visualization.LineChart,options:{vAxis:{format:"##.#%"}}}]}]},cost_of_living:{name:"Cost of Living",groups:[{name:"Cost of Living Indexes (100 is the U.S. Average)",attribution:attributions.bea,domain:ODN_DOMAIN,fxf:"hpnf-gnfu",charts:["All","Rents","Goods","Other"].map(function(e){return{name:"Category: "+e,params:{component:e},data:[{column:"year",label:"Year",type:"string"},{column:"index",label:"Index"}],chart:google.visualization.LineChart}})}]}},DEFAULT_SOURCE=SOURCES.population,_slicedToArray=function(){function e(e,t){var n=[],a=!0,r=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(l){r=!0,o=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),Tab=function(){function e(t){if(_classCallCheck(this,e),!t.name)throw Error("tab missing name");if(this.name=t.name,this.description=t.description||"",!t.groups)throw Error("tab missing groups");this.groups=t.groups.map(function(e){return new ChartGroup(e)})}return _createClass(e,[{key:"render",value:function(e,t){this.groups.forEach(function(n){return n.render(e,t)})}}]),e}(),ChartGroup=function(){function e(t){var n=this;if(_classCallCheck(this,e),!t.name)throw Error("group missing name");if(this.name=t.name,!t.attribution)throw Error("group missing attribution");if(this.attribution=t.attribution,!t.domain)throw Error("group missing domain");if(this.domain=t.domain,!t.fxf)throw Error("group missing fxf");if(this.fxf=t.fxf,this.path="https://"+this.domain+"/resource/"+this.fxf+".json",this.idColumn=t.idColumn||"id",!t.charts)throw Error("group missing charts");this.charts=t.charts.map(function(e){return new Chart(n,e)})}return _createClass(e,[{key:"render",value:function(e,t){var n=e.append("div").attr("class","chart-group");n.append("h2").attr("class","chart-group-heading").text(this.name),this.charts.forEach(function(e){return e.render(n,t)})}}]),e}(),Chart=function(){function e(t,n){if(_classCallCheck(this,e),this.group=t,this.name=n.name||"",!n.data)throw Error("chart missing data");if(this.data=e._columns(n.data),this.x=n.data[0],this.y=n.data[1],!n.chart)throw Error("chart missing chart");if(this.chart=n.chart,this.options=_.extend({},Constants.DEFAULT_CHART_OPTIONS,n.options||{},{title:this.name}),this.transform=n.transform,n.transpose&&2!==n.transpose.length)throw Error("transpose requires two variables");n.transpose&&(this.transpose=e._columns(n.transpose)),this.params=n.params||{}}return _createClass(e,[{key:"render",value:function(e,t){var n=this;this.getData(t).then(function(a){n.transpose&&(a=n._transpose(a)),n.transform&&(a=n.transform(a));var r=n.dataTable(a,t),o=e.append("div").attr("class","chart-container"),i=new n.chart(o[0][0]);i.draw(r,n.options)},function(e){console.error(e)})}},{key:"_transpose",value:function(e){var t=this;return this.x=this.transpose[0],this.y=this.transpose[1],_.flatten(e.map(function(e){return t.data.map(function(n){var a;return a={id:e[t.group.idColumn]},_defineProperty(a,t.x.column,n.label),_defineProperty(a,t.y.column,e[n.column]),a})}))}},{key:"getData",value:function(e){var t=[this.group.idColumn].concat(this.data.map(function(e){return e.column})),n=_.extend({$select:t.join(","),$where:"id in ("+e.map(function(e){return"'"+e.id+"'"})+")",$order:t.map(function(e){return e+" ASC"}).join(",")},this.params),a=this.group.path+"?"+$.param(n);return d3.promise.json(a)}},{key:"dataTable",value:function(e,t){var n=this,a=t.map(function(e){return{label:e.name,type:n.y.type}}),r=[this.x].concat(a),o=_.groupBy(e,function(e){return e[n.x.column]}),i=_.pairs(o).map(function(e){var a=_slicedToArray(e,2),r=a[0],o=a[1],i=_.indexBy(o,function(e){return e[n.group.idColumn]});return[r].concat(t.map(function(e){return i[e.id][n.y.column]}))}),s=google.visualization.arrayToDataTable([r].concat(i));if(this.x.formatter){var l=new this.x.formatter(this.x.formatterOptions||{});l.format(s,0)}return this.y.formatter&&!function(){var e=new n.y.formatter(n.y.formatterOptions||{});_.range(1,r.length).forEach(function(t){e.format(s,t)})}(),s}}],[{key:"_columns",value:function(e){return e.map(function(e){return e.type=e.type||"number",e.label=e.label||"",e.column=e.column||"",e})}}]),e}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),SearchPageController=function(){function e(t,n,a){function r(e){RegionLookup.byID(e.id).then(function(e){i.setAutoSuggestedRegion({id:e.id,name:e.name},!1),i.navigate()},function(e){throw e})}var o=this;_classCallCheck(this,e),this.params=t,this.tableData=n,this.mapVariables=a,this.fetching=!1,this.fetchedAll=!1,this.mostSimilar=[];var i=this;$(".refine-link").mouseenter(function(){$(this).addClass("refine-link-selected"),$(this).children("span").children("i").removeClass("fa-caret-down").addClass("fa-caret-up"),$(this).children("ul").slideDown(100)}),$(".refine-link").mouseleave(function(){$(this).removeClass("refine-link-selected"),$(this).children("span").children("i").removeClass("fa-caret-up").addClass("fa-caret-down"),$(this).children("ul").slideUp(100)}),this.attachCategoriesClickHandlers(),$("#refine-menu-categories-view-more").click(function(){d3.promise.json("/categories.json").then(function(e){var t=e.results.map(function(e){return'<li><i class="fa '+e.metadata.icon+'"></i>'+e.category+"</li>"}),n=t.join("");$("#refine-menu-categories").html(n),i.attachCategoriesClickHandlers()},console.error)}),this.attachDomainsClickHandlers(),$("#refine-menu-domains-view-more").click(function(){d3.promise.json("https://api.us.socrata.com/api/catalog/v1/domains").then(function(e){var t=e.results.map(function(e){return"<li>"+e.domain+"</li>"}),n=t.join("");$("#refine-menu-domains").html(n),i.attachDomainsClickHandlers()},console.error)}),this.attachTagsClickHandlers(),$(".region-token .fa-times-circle").click(function(){i.removeRegion($(this).parent().index()),i.navigate()}),$(".category-token .fa-times-circle").click(function(){i.toggleCategory($(this).parent().text().toLowerCase().trim()),i.navigate()}),$(".domain-token .fa-times-circle").click(function(){i.toggleDomain($(this).parent().text().toLowerCase().trim()),i.navigate()}),$(".standard-token .fa-times-circle").click(function(){i.toggleTag($(this).parent().text().toLowerCase().trim()),i.navigate()}),$(window).on("scroll",function(){var e=1e3;$(window).scrollTop()>=$(document).height()-$(window).height()-e&&i.fetchNextPage()}).scroll();var s=regionsWithData(this.params.vector,r),l=new Autosuggest(".add-region-results",s);l.listen(".add-region-input"),$(".add-region .fa-plus").click(function(){$('.add-region input[type="text"]').focus()});var u=this.params.regions,c=this.params.vector;if(u.length>0&&(c in MAP_SOURCES&&!function(){var e=MAP_SOURCES[c];console.log(e),e.selectedIndices=o.mapVariables;var t=function(t,n){o.updateAddressBarUrl(t.metric,n);var a=MapSummary.getSummaryString(u,o.tableData,t,n,function(e){return n==e.year});$(".map-summary").text(a),o.drawMapSummaryLinks(e,t,n)};MapView.create(e,u,t).then(function(e){return e.show("#map")},function(e){return console.warn(e)})}(),c in SOURCES)){var f=SOURCES[c];new Tab(f).render(d3.select("div.charts"),u)}$(".map-summary-more").click(function(){$(".map-summary-links").slideToggle(100),$(".map-summary-more").text("More Information"==$(".map-summary-more").text()?"Less Information":"More Information")})}return _createClass(e,[{key:"drawMapSummaryLinks",value:function(e,t,n){var a=this,r=_.filter(e.variables,function(e){return e.name!=t.name}),o=$(".map-summary-links").empty();$.each(r,function(e){var t=r[e],i=$("<li/>").appendTo(o);$("<a/>").attr("href",a.getSearchPageUrl(!1,t.metric,n)).text(t.name).appendTo(i)})}},{key:"attachCategoriesClickHandlers",value:function(){var e=this;$("#refine-menu-categories li:not(.refine-view-more)").click(function(){e.toggleCategory($(this).text().toLowerCase().trim()),e.navigate()})}},{key:"attachDomainsClickHandlers",value:function(){var e=this;$("#refine-menu-domains li:not(.refine-view-more)").click(function(){var t=$(this).text().toLowerCase().trim();e.toggleDomain(t),e.navigate()})}},{key:"attachTagsClickHandlers",value:function(){var e=this;$("#refine-menu-tags li").click(function(){var t=$(this).text().toLowerCase().trim();e.toggleTag(t),e.navigate()})}},{key:"decrementPage",value:function(){this.params.page--}},{key:"fetchNextPage",value:function(){if(!this.fetching&&!this.fetchedAll){this.fetching=!0,this.incrementPage();var e=this;$.ajax(this.getSearchResultsUrl()).done(function(t,n,a){return 204==a.status?(e.decrementPage(),e.fetching=!1,void(e.fetchedAll=!0)):($(".datasets").append(t),void(e.fetching=!1))})}}},{key:"getSearchPageForRegionVectorMetricYearUrl",value:function(e,t,n,a,r,o,i){var s="";if(e&&e.length>0)if(s+="/region/"+e.join("-"),t&&t.length>0){var l=t.map(function(e){return e.replace(/ /g,"_").replace(/\//g,"_").replace(/,/g,"")});s+="/"+l.join("-")}else s+="/-";else s+="/search";return o?s+="/search-results":(n&&(s+="/"+n),a&&(s+="/"+a),r&&(s+="/"+r)),i&&(s+=i),s}},{key:"getSearchPageUrl",value:function(e,t,n){if(this.params.regions.length>0||this.params.autoSuggestedRegion){var a=[],r=[];return this.params.resetRegions===!1&&(a=this.params.regions.map(function(e){return e.id}),r=this.params.regions.map(function(e){return e.name})),this.params.autoSuggestedRegion&&(a.push(this.params.autoSuggestedRegion.id),r.push(this.params.autoSuggestedRegion.name)),this.getSearchPageForRegionVectorMetricYearUrl(a,r,this.params.vector||"population",t,n,e,this.getSearchQueryString(e))}return this.getSearchPageForRegionVectorMetricYearUrl(null,null,this.params.vector||"population",t,n,e,this.getSearchQueryString(e))}},{key:"getSearchResultsUrl",value:function(){return this.getSearchPageUrl(!0)}},{key:"getSearchQueryString",value:function(e){var t=[];return this.params.q.length>0&&t.push("q="+encodeURIComponent(this.params.q)),this.params.page>1&&e&&t.push("page="+this.params.page),this.params.categories.length>0&&this.params.categories.forEach(function(e){return t.push("categories="+encodeURIComponent(e))}),this.params.domains.length>0&&this.params.domains.forEach(function(e){return t.push("domains="+encodeURIComponent(e))}),this.params.tags.length>0&&this.params.tags.forEach(function(e){return t.push("tags="+encodeURIComponent(e))}),t.length>0?"?"+t.join("&"):""}},{key:"incrementPage",value:function(){this.params.page++}},{key:"navigate",value:function(){window.location.href=this.getSearchPageUrl()}},{key:"removeRegion",value:function(e){this.params.regions.splice(e,1),this.params.page=1,0===this.params.regions.length&&(this.params.vector="")}},{key:"setAutoSuggestedRegion",value:function(e,t){this.params.autoSuggestedRegion=e,this.params.resetRegions=t,this.params.page=1}},{key:"toggleCategory",value:function(e){var t=this.params.categories.indexOf(e);t>-1?this.params.categories.splice(t,1):this.params.categories.push(e),this.params.page=1}},{key:"toggleDomain",value:function(e){var t=this.params.domains.indexOf(e);t>-1?this.params.domains.splice(t,1):this.params.domains.push(e),this.params.page=1}},{key:"toggleTag",value:function(e){var t=this.params.tags.indexOf(e);t>-1?this.params.tags.splice(t,1):this.params.tags=[e],this.params.page=1,this.params.categories=[],this.params.domains=[],this.params.q="",this.params.regions=[],this.params.vector=""}},{key:"updateAddressBarUrl",value:function(e,t){var n=this.getSearchPageUrl(!1,e,t);history.replaceState(null,null,n)}}]),e}();$(document).ready(function(){new SearchPageController(_params,_tableData,_mapVariables),multiComplete("#q",".region-list").listen(),$(".fa-close").click(function(){$(".current-category").fadeOut()}),$(".info-icon").mouseenter(function(){$(".info-tooltip").fadeIn()}),$(".info-icon").mouseleave(function(){$(".info-tooltip").fadeOut()})});
//# sourceMappingURL=search.min.js.map
